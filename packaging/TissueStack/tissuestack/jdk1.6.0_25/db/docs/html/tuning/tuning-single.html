<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><META http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Tuning Java DB</title><META content="text/css" http-equiv="Content-Style-Type"><style type="text/css">
        a { color: black; border: none; text-decoration: none; }
        img { border: none; }
      </style></head><body topmargin="6" leftmargin="6" marginheight="6" marginwidth="6" bgcolor="white"><br><div valign="top"><div style="padding: 6pt; border-width: thin; border-color: black; font-family: Helvetica; margin-top: 2pc;"><div style="text-align: right; margin-bottom: 12pc; margin-top: 12pc; line-height: 100%; font-size: 12pt;"></div></div><a name="cover"></a><div style="font-family: Helvetica; text-align: left;"><div style="line-height: 140%; font-weight: bold; font-size: 22pt;">Tuning Java DB</div><div style="font-style: italic; margin-bottom: 1in; line-height: 140%; font-size: 8pt;">
          Version 10.6</div></div><div style="line-height: normal; font-size: 8pt; text-align: right; margin-top: 3pc;">
          Derby Document build: <div>September 22, 2010, 4:26:37 PM (EDT)</div></div></div><br><br><div valign="top"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em; text-align: center; color: purple;"></div></div><br><br><div valign="top"><div style="font-style: italic; margin-bottom: 1in; line-height: 140%; font-size: 8pt;">
          Version 10.6
         &nbsp;
	Tuning Java DB</div></div><div valign="top"><a name="page1-1"></a><div style="font-family: Helvetica; font-size: 10pt; line-height: 12pt;"><div style="font-family: Helvetica; text-align: left;"><div> &nbsp;&nbsp;&nbsp; </div><a name="contents"></a><div style="line-height: 140%; font-weight: bold; font-size: 20pt;">
              Contents </div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#rtuncopyright"><span style="font-weight: bold;">Copyright</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#rtunlicense"><span style="font-weight: bold;">License</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#ctunjavadb"><span style="font-weight: bold;">Relationship between Java DB and Derby</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#ctunpropref1002477"><span style="font-weight: bold;">About this guide</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunpropref11181"><span style="font-weight: bold;">Purpose of this guide</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunpropref22460"><span style="font-weight: bold;">Audience</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunpropref23947"><span style="font-weight: bold;">How this guide is organized</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#ctunperf22457"><span style="font-weight: bold;">Performance tips and tricks</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunperf25864"><span style="font-weight: bold;">The tips</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf18705">Use prepared statements with substitution parameters &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf10679">Create indexes, and make sure they are being used &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperfstatistics">Ensure table statistics are accurate &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf54492">Increase the size of the data page cache &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf10065">Tune the size of database pages &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf23868">Avoid expensive queries &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf98197">Use the appropriate getXXX and setXXX methods for the type &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf16556">Tune database booting/class loading &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf16800">Avoid inserts in autocommit mode if possible &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperftablefunctions">Improve the performance of table functions &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperfinmemdb">Configure Derby to
use an in-memory database &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunperf31086"><span style="font-weight: bold;">More tips</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf17936">Shut down the system properly &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunperf816635">Put Derby first in your classpath &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#ctundepth39739"><span style="font-weight: bold;">Tuning databases and applications</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctundepth21935"><span style="font-weight: bold;">Application and database design issues</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctundepth10525">Avoiding table scans of large tables &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctundepth29804">Avoiding compiling SQL statements &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctundepth14326">Shielding users from Derby class-loading events &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ttundepth33391"><span style="font-weight: bold;">Analyzing statement execution</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctundepth13055"><span style="font-weight: bold;">Working with RunTimeStatistics</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctundepth26674">Overview &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ttundepth34375">How you use the RUNTIMESTATISTICS attribute &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctun_xplain_style">How you use the XPLAIN style &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctundepth37648">Analyzing the information &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#ctunoptimz39739"><span style="font-weight: bold;">DML statements and performance</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunoptimz23977"><span style="font-weight: bold;">Performance and optimization</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunoptimz30217">Index use and access paths &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunoptimz12168">Joins and performance &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunoptimz42425">Derby's cost-based optimization &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunoptimz27975"><span style="font-weight: bold;">Locking and performance</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunoptimz42065">Transaction-based lock escalation &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunoptimz11775">Locking a table for the duration of a transaction &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunoptimz860097"><span style="font-weight: bold;">Non-cost-based optimizations</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunoptimz22460">Non-cost-based sort avoidance (tuple filtering) &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunoptimz22111">The MIN() and MAX() optimizations &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunoptimzoverride"><span style="font-weight: bold;">Overriding the default optimizer behavior</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#ctunstats18908"><span style="font-weight: bold;">Selectivity and cardinality statistics</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunstats57793"><span style="font-weight: bold;">Determinations of rows scanned from disk for a table scan</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunstats848901">How the optimizer determines the number of rows in a table &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunstats60669"><span style="font-weight: bold;">Estimations of rows scanned from disk for an index scan</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunstats848961">Queries with a known search condition &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunstats849000">Queries with an unknown search condition &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunstats849203"><span style="font-weight: bold;">Statistics-based versus hard-wired selectivity</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunstats72938">Selectivity from cardinality statistics &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunstats52657">Selectivity from hard-wired assumptions &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunstats849251"><span style="font-weight: bold;">What are cardinality statistics?</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctunstats46438"><span style="font-weight: bold;">Working with cardinality statistics</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunstats57373">When cardinality statistics are automatically updated &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctunstats849505">When cardinality statistics go stale &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#ctuntransform13966"><span style="font-weight: bold;">Internal language transformations</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctuntransform35783"><span style="font-weight: bold;">Predicate transformations</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#rtuntransform139">BETWEEN transformations &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#rtuntransform208">LIKE transformations &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#rtuntransform582">Simple IN predicate transformations &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#rtuntransform866214">NOT IN predicate transformations &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#rtuntransform590">OR transformations &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctuntransform37032"><span style="font-weight: bold;">Transitive closure</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#rtuntransform866547">Transitive closure on join clauses &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#rtuntransform866587">Transitive Closure on Search Clauses &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctuntransform11313"><span style="font-weight: bold;">View transformations</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform22576">View flattening &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform36623">Predicates pushed into views or derived tables &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctuntransform13699"><span style="font-weight: bold;">Subquery processing and transformations</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform25857">Materialization &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform36368">Flattening a subquery into a normal join &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform25868">Flattening a subquery into an EXISTS join &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform47182">Flattening VALUES subqueries &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform867165">DISTINCT elimination in IN, ANY, and EXISTS subqueries &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform867201">IN/ANY subquery transformation &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctuntransform55045"><span style="font-weight: bold;">Outer join transformations</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctuntransform16033"><span style="font-weight: bold;">Sort avoidance</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform16279">DISTINCT elimination based on a uniqueness condition &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform21780">Combining ORDER BY and DISTINCT &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#ctuntransform14044">Combining ORDER BY and UNION &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 7.5pc;"><a href="#ctuntransform41535"><span style="font-weight: bold;">Aggregate processing</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 9pc;"><a href="#rtuntransform867602">COUNT(nonNullableColumn) &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div><div style="margin-left: 4.9pc; margin-top: 6pt;"><a href="#rtuntrademderby"><span style="font-weight: bold;">Trademarks</span> &nbsp;&nbsp;&nbsp; <span>&bull;</span></a></div></div></div></div><div valign="top"><div style="font-family: Helvetica; font-weight: bold; font-size: 10pt; text-align: center;"><span>&bull;</span></div></div><br><br><div valign="top"><div style="line-height: 8pt; font-size: 8pt;">Tuning Java DB</div></div><div valign="top"><div style="font-family: Helvetica; font-size: 10pt; text-align: left;">Apache Software FoundationTuning Java DBApache Derby<div><a name="N1003D"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="rtuncopyright"></a><div></div>Copyright</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N10046"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><img src="../images/logowithtext.jpg" alt="Logo for Apache Derby"></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Copyright 2004-2010 The Apache Software Foundation</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Copyright 2010 Oracle and/or its affiliates. All rights reserved.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"> Licensed
under the Apache License, Version 2.0 (the "License"); you may not use this
file except in compliance with the License. You may obtain a copy of the License
at <span style="color: blue;"><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></span>.</div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N10071"></a><span></span><div style="font-weight: bold;">Related information</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="color: blue;"><a href="#rtunlicense">License</a></span></div></div></div></div><div><a name="N1008F"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="rtunlicense"></a><div></div>License</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em; margin-left: 72pt;"></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N100B2"></a><span></span><div style="font-weight: bold;">The Apache License, Version 2.0</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
                               Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      "License" shall mean the terms and conditions for use,
      reproduction, and distribution as defined by Sections 1 through
      9 of this document.

      "Licensor" shall mean the copyright owner or entity authorized
      by the copyright owner that is granting the License.

      "Legal Entity" shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under
      common control with that entity. For the purposes of this
      definition, "control" means (i) the power, direct or indirect,
      to cause the direction or management of such entity, whether by
      contract or otherwise, or (ii) ownership of fifty percent (50%)
      or more of the outstanding shares, or (iii) beneficial ownership
      of such entity.

      "You" (or "Your") shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      "Source" form shall mean the preferred form for making
      modifications, including but not limited to software source code,
      documentation source, and configuration files.

      "Object" form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      "Work" shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      "Derivative Works" shall mean any work, whether in Source or
      Object form, that is based on (or derived from) the Work and
      for which the editorial revisions, annotations, elaborations,
      or other modifications represent, as a whole, an original work
      of authorship.  For the purposes of this License, Derivative
      Works shall not include works that remain separable from, or
      merely link (or bind by name) to the interfaces of, the Work
      and Derivative Works thereof.

      "Contribution" shall mean any work of authorship, including
      the original version of the Work and any modifications or
      additions to that Work or Derivative Works thereof, that is
      intentionally submitted to Licensor for inclusion in the Work
      by the copyright owner or by an individual or Legal Entity
      authorized to submit on behalf of the copyright owner. For the
      purposes of this definition,
      "submitted" means any form of electronic, verbal, or written
      communication sent to the Licensor or its representatives,
      including but not limited to communication on electronic mailing
      lists, source code control systems, and issue tracking systems
      that are managed by, or on behalf of, the Licensor for the
      purpose of discussing and improving the Work, but excluding
      communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as "Not a
      Contribution."

      "Contributor" shall mean Licensor and any individual or Legal
      Entity on behalf of whom a Contribution has been received by
      Licensor and subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions
      of this License, each Contributor hereby grants to You a
      perpetual, worldwide, non-exclusive, no-charge, royalty-free,
      irrevocable copyright license to reproduce, prepare Derivative
      Works of, publicly display, publicly perform, sublicense, and
      distribute the Work and such Derivative Works in Source or
      Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have
      made, use, offer to sell, sell, import, and otherwise transfer
      the Work, where such license applies only to those patent claims
      licensable by such Contributor that are necessarily infringed by
      their Contribution(s) alone or by combination of their
      Contribution(s) with the Work to which such Contribution(s) was
      submitted. If You institute patent litigation against any entity
      (including a cross-claim or counterclaim in a lawsuit) alleging
      that the Work or a Contribution incorporated within the Work
      constitutes direct or contributory patent infringement, then any
      patent licenses granted to You under this License for that Work
      shall terminate as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a "NOTICE" text file as part of its
          distribution, then any Derivative Works that You distribute
          must include a readable copy of the attribution notices
          contained within such NOTICE file, excluding those notices
          that do not pertain to any part of the Derivative Works, in
          at least one of the following places: within a NOTICE text
          file distributed as part of the Derivative Works; within the
          Source form or documentation, if provided along with the
          Derivative Works; or, within a display generated by the
          Derivative Works, if and wherever such third-party notices
          normally appear. The contents of the NOTICE file are for
          informational purposes only and do not modify the License.
          You may add Your own attribution notices within Derivative
          Works that You distribute, alongside or as an addendum to
          the NOTICE text from the Work, provided that such additional
          attribution notices cannot be construed as modifying the
          License.

      You may add Your own copyright statement to Your modifications
      and may provide additional or different license terms and
      conditions for use, reproduction, or distribution of Your
      modifications, or for any such Derivative Works as a whole,
      provided Your use, reproduction, and distribution of the Work
      otherwise complies with the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state
      otherwise, any Contribution intentionally submitted for
      inclusion in the Work by You to the Licensor shall be under the
      terms and conditions of this License, without any additional
      terms or conditions.  Notwithstanding the above, nothing herein
      shall supersede or modify the terms of any separate license
      agreement you may have executed with Licensor regarding such
      Contributions.

   6. Trademarks. This License does not grant permission to use the
      trade names, trademarks, service marks, or product names of the
      Licensor, except as required for reasonable and customary use
      in describing the origin of the Work and reproducing the content
      of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or
      conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or
      FITNESS FOR A PARTICULAR PURPOSE. You are solely responsible for
      determining the appropriateness of using or redistributing the
      Work and assume any risks associated with Your exercise of
      permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and
      grossly negligent acts) or agreed to in writing, shall any
      Contributor be liable to You for damages, including any direct,
      indirect, special, incidental, or consequential damages of any
      character arising as a result of this License or out of the use
      or inability to use the Work (including but not limited to
      damages for loss of goodwill, work stoppage, computer failure or
      malfunction, or any and all other commercial damages or losses),
      even if such Contributor has been advised of the possibility of
      such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by
      reason of your accepting any such warranty or additional
      liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets "[]"
      replaced with your own identifying information. (Don't include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same "printed page" as the copyright notice for easier
      identification within third-party archives.

   Copyright [yyyy] [name of copyright owner]

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
   implied.  See the License for the specific language governing
   permissions and limitations under the License.
</div></pre></div></div></div><div><a name="N100D5"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="ctunjavadb"></a><div></div>Relationship between Java DB and <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span></div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em; margin-left: 72pt;">Java DB is a relational database management 
system that is based on the Java programming language and SQL. Java DB is a 
commercial release of the Apache Software Foundation's (ASF) open source 
relational database project. The Apache project is called 
<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The Java DB product includes 
<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> without any 
modification whatsoever to the underlying source code.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Java DB technical support is available for purchase through the Java For
Business product at Oracle.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Because Java DB and <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> 
have the same functionality, the Java DB documentation refers to the core 
functionality as <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Java DB <span style="border-right-width: 0pt; border-left-width: 0pt;">Version 10.6</span> is based 
on the <span style="border-right-width: 0pt; border-left-width: 0pt;">Version 10.6</span> release of
<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>. References to
"<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>" in the 
Java DB documentation refer to the 
<span style="border-right-width: 0pt; border-left-width: 0pt;">Version 10.6</span> release of  
<span style="border-right-width: 0pt; border-left-width: 0pt;">Apache Derby</span>.</div></div></div><div><a name="N10158"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="ctunpropref1002477"></a><div></div>About this guide</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For general information about the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> documentation,
such as a complete list of books, conventions, and further reading, see <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Getting Started with Java DB</span></span></span>.</div></div><div><a name="N101C1"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunpropref11181"></a><div></div>Purpose of this guide</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This guide, <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Tuning Java DB</span></span></span>,
explains how to tune systems, databases, specific tables and indexes, and
queries for performance. This guide also provides an in-depth study
of query optimization and performance issues.</div></div></div><div><a name="N1021B"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunpropref22460"></a><div></div>Audience</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This book is a reference for <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> users, typically application developers. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> users
who are not familiar with the SQL standard or the Java programming language
will benefit from consulting books on those topics. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> users who want a how-to approach to working with <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> or
an introduction to <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> concepts should read the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Developer's Guide</span></span></span>. This book is for users who want to optimize and tune their application's
performance.</div></div></div><div><a name="N10297"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunpropref23947"></a><div></div>How this guide is organized</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">This guide includes the following sections:
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf22457">Performance tips and tricks</a></span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Quick tips on how to improve the performance of <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> applications.</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctundepth39739">Tuning databases and applications</a></span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A more in-depth discussion of how to improve the performance of <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> applications.</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunoptimz39739">DML statements and performance</a></span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">An in-depth study of how <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> executes queries, how the optimizer works,
and how to tune query execution.</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunstats18908">Selectivity and cardinality statistics</a></span></span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctuntransform13966">Internal language transformations</a></span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Reference on how <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> internally transforms some SQL statements
for performance reasons. Not of interest to the general user.</div></div></td></tr></table></div></div></div></div></div><div><a name="N1035E"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="ctunperf22457"></a><div></div>Performance tips and tricks</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This chapter lists tips for improving the performance of your <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> application.
For a more in-depth discussion of performance, see <span style="color: blue;"><a href="#ctundepth39739">Tuning databases and applications</a></span>.</div></div><div><a name="N103AF"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunperf25864"></a><div></div>The tips</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf18705">Use prepared statements with substitution parameters</a></span></span> to save
on costly compilation time. Prepared statements using substitution parameters
significantly improves performance in applications using standard statements.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf10679">Create indexes, and make sure they are being used</a></span>.</span> Indexes
speed up queries dramatically if the table is much larger than the number
of rows retrieved.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperfstatistics">Ensure
            table statistics are accurate</a></span></span>, since missing or out
    of data statistics can result in poor query plan selection.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf54492">Increase the size of the data page cache</a></span></span> and prime
all the caches.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf10065">Tune the size of database pages</a></span>.</span> Using
large database pages has provided a performance improvement of <span style="font-style: italic;">up to 50%</span>. There are also other storage parameters worth tweaking. If
you use large database pages, increase the amount of memory available to <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf23868">Avoid expensive queries</a></span>.</span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf98197">Use the appropriate getXXX and setXXX methods for the type</a></span>.</span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf16556">Tune database booting/class loading</a></span>.</span> System
startup time can be improved by reducing the number of databases in the system
directory. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperf16800">Avoid inserts in autocommit mode if possible</a></span></span>. Speed
up insert performance.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperftablefunctions">Improve the performance of table functions</a></span></span>. Force
more efficient join orders for queries which use table functions.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><span style="color: blue;"><a href="#ctunperfinmemdb">Configure Derby to use an in-memory database</a></span></span>. Tune the
Java heap and <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> page
cache size when using an in-memory database.</div></td></tr></table></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">These tips might solve your particular performance problem. Be sure to
visit the Support section of <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>'s Web site for up-to-date performance
tips and tricks.</div></div><div><a name="N10550"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf18705"></a><div></div>Use prepared statements with substitution parameters</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>, as with most relational database management systems, performing
an SQL request has two steps: compiling the request and executing it. When
you use prepared statements (<span style="font-style: italic;">java.sql.PreparedStatement</span>) instead of statements (<span style="font-style: italic;">java.sql.Statement</span>)
you can help <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> avoid unnecessary compilation, which saves time.
In general, any query that you will use more than once should be a prepared
statement. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For more information, see <span style="color: blue;"><a href="#ctundepth29804">Avoiding compiling SQL statements</a></span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Using prepared statements can result in significant performance improvement,
depending on the complexity of the query. More complex queries show greater
benefit from being prepared.</div></div></div><div><a name="N10635"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf10679"></a><div></div>Create indexes, and make sure they are being used</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">By creating indexes on columns by which you often search a table, you can
reduce the number of rows that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> has to scan, thus improving performance.
Depending on the size of the table and the number of rows returned, the improvement
can be dramatic. Indexes work best when the number of rows returned from the
query is a fraction of the number of rows in the table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">There are some trade-offs in using indexes: indexes speed up searches but
slow down inserts and updates. As a general rule, every table should have
at least a primary key constraint.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">See <span style="color: blue;"><a href="#ctundepth23033">Always create indexes</a></span> for more information.</div></div></div><div><a name="N1071A"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperfstatistics"></a><div></div>Ensure table statistics are accurate</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">As described in <span style="color: blue;"><a href="#ctunstats849251">
        What are cardinality statistics?</a></span>,
    the cardinality statistics for a table influence the optimizer's
    choice of a query plan
for a query which accesses the table's data.
If the cardinality statistics are missing or out of date, the optimizer may
choose an inferior query plan, resulting in poor performance.
</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
One common situation which can causing missing or out of date statistics is
when indexes are created before the data is added to the tables.
Cardinality statistics are automatically updated in certain situations, such as
when an index is added to an existing non-empty table.
<span style="color: blue;"><a href="#ctunstats57373">When cardinality
    statistics are automatically updated</a></span> describes the automatic
statistics updates in more detail.
However, adding, updating, and deleting data after the index
has been created can cause the cardinality statistics to become stale; see
<span style="color: blue;"><a href="#ctunstats849505">
    when cardinality statistics go stale</a></span> for more information about
what can cause missing or out of date statistics..
</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">
To ensure that the statistics are available and accurate, you can run either
of the following built-in system procedures:
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-family: Courier;">SYSCS_UTIL.SYSCS_COMPRESS_TABLE</span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-family: Courier;">SYSCS_UTIL.SYSCS_UPDATE_STATISTICS</span></div></td></tr></table></div>
Note that the <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE</span>
system procedure does <span style="font-weight: bold;">not</span> update statistics as part of its
processing.
</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
You can find additional information about these system procedures, including
the syntax for invoking them, in the
<span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span>.
</div></div></div><div><a name="N1084C"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf54492"></a><div></div>Increase the size of the data page cache</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">You can increase the size of a database's data page cache, which consists
of the data pages kept in memory. When <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can access a database page
from the cache instead of reading it from disk, it can return data much more
quickly.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The default size of the data page cache is 1000 pages. In a multi-user
environment, or in an environment where the user accesses a lot of data, increase
the size of the cache. You configure its size with the <span style="font-style: italic;">derby.storage.pageCacheSize</span> property. For more information about
how to set this property and how to estimate memory use, see the
"<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> properties" section of
the <span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span>.</div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can
run even with a small amount of memory and even with a small data page cache,
although it might perform poorly. Increasing the amount of memory available
to <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> and increasing the size of the data page cache improve performance.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In addition, you might want to prime <span style="font-style: italic;">all</span> the caches
in the background to make queries run faster when the user gets around to
running them.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">These caches include:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The page (user data) cache (described above)  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Prime this cache by selecting
from much-used tables that are expected to fit into the data page cache.</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The data dictionary cache  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The cache that holds information stored
in the system tables. You can prime this cache with a query that selects from
commonly used user tables.</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The statement cache  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The cache that holds database-specific <span style="font-style: italic;">Statements</span> (including <span style="font-style: italic;">PreparedStatements</span>). You
can prime this cache by preparing common queries ahead of time in a separate
thread.</div></div></td></tr></table></div></div></div></div><div><a name="N10992"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf10065"></a><div></div>Tune the size of database pages</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Stick with 4K as the page size (the default, and the size operating systems
use) unless:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>You are storing large objects.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>You have very large tables (over 10,000 rows).  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For very large tables,
large pages reduces the number of I/Os required.</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For read-only applications, use a large page size (for example, 32K) with
a <span style="font-style: italic;">pageReservedSpace</span> of 0.</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">You might need to experiment with page size to find out what works best
for your application and database.</div></div><div><a name="N10A9A"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunperf816059"></a><div></div>Performance trade-offs of large pages</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Using large database pages benefits database performance, notably decreasing
I/O time. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> automatically
tunes for the database page size. If you have long columns, the default page
size for the table is set to 32768 bytes. Otherwise, the default is 4096 bytes.
You can change the default database page size with the <span style="font-style: italic;">derby.storage.pageSize</span> property,
described in the "<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>
properties" section of the <span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span>.
For example:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">derby.storage.pageSize=8192</span></div></pre></div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  Large database pages require more memory.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If row size is large, generally page size should be correspondingly large.
If row size is small, page size should be small. Another rough guideline is
to try to have at least 10 average-sized rows per page (up to 32K).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Use a larger page size for tables with large columns or rows. Maximum page
size allowed is 32k.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">However, some applications involve rows whose size will vary considerably
from user to user. In that situation, it is hard to predict what effect page
size will have on performance.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If a table contains one large column along with several small columns,
put the large column at the end of the row, so that commonly used columns
will not be moved to overflow pages. Do not index large columns.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Large page size for indexes improves performance considerably.</div></div><div><a name="N10B41"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunperf1004126"></a><div></div>When large page size does not improve performance: </div><div style="margin-left: 72pt; font-size: 10pt;"><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">Selective Queries</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If your application's
queries are very selective and use an index, large page size does not provide
much benefit and potentially degrades performance because a larger page takes
longer to read.</div></div></td></tr></table></div></div></div><div><a name="N10B8C"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunperf1004182"></a><div></div>When large page size is not desirable: </div><div style="margin-left: 72pt; font-size: 10pt;"><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">Limited memory</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Large database pages reduce
I/O time because <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can access more data with fewer I/Os. However,
large pages require more memory. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> allocates a bulk number of database
pages in its page cache by default. If the page size is large, the system
might run out of memory.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Here's a rough guideline: If the system
is running Windows 95 and has more than 32 MB (or Windows NT and has more
than 64 MB), it is probably beneficial to use 8K rather than 4K as the default
page size.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Use the <span style="font-style: italic;">-mx</span> flag as an optional parameter
to the JVM to give the JVM more memory upon startup.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">java -mx64 myApp</span></div></pre></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">Limited disk space</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If you cannot afford the
overhead of the minimum two pages per table, keep your page sizes small.</div></div></td></tr></table></div></div></div></div></div><div><a name="N10C18"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf23868"></a><div></div>Avoid expensive queries</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Some queries can, and should, be avoided. Two examples:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT DISTINCT nonIndexedCol FROM HugeTable

SELECT * FROM HugeTable ORDER BY nonIndexedColumn</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">See <span style="color: blue;"><a href="#ctundepth36205">Prevent the user from issuing expensive queries</a></span>.</div></div></div><div><a name="N10CEA"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf98197"></a><div></div>Use the appropriate getXXX and setXXX methods for the type</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em; margin-left: 72pt;">For performance reasons, use the recommended <span style="font-style: italic;">getXXX</span> method
when retrieving values, and use the recommended <span style="font-style: italic;">setXXX</span> method when
setting values for parameters.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">JDBC is permissive. It lets you use <span style="font-style: italic;">java.sql.ResultSet.getFloat</span> to
retrieve an int, <span style="font-style: italic;">java.sql.ResultSet.getObject</span> to retrieve any type,
and so on.  (<span style="font-style: italic;">java.sql.ResultSet </span>and <span style="font-style: italic;">java.sql.CallableStatement</span> provide <span style="font-style: italic;">getXXX</span> methods,
and <span style="font-style: italic;">java .sql.PreparedStatement</span> and <span style="font-style: italic;">java.sql.CallableStatement</span> provide <span style="font-style: italic;">setXXX</span> methods.)
This permissiveness is convenient but expensive in terms of performance.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following table shows the recommended <span style="font-style: italic;">getXXX</span> methods for given <span style="font-style: italic;">java.sql</span> (JDBC)
types, and their corresponding SQL types.   <div><div style="font-weight: bold;"><span style="color: red;">Table 1. </span>Mapping of java.sql.Types to SQL types</div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><thead><tr><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Recommended <span style="font-weight: bold;"><span style="font-style: italic;">getXXX</span></span> Method</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-style: italic;">java.sql.Types</span></span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>SQL types</div></td></tr></thead><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getLong</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>BIGINT</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>BIGINT</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getBytes</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>BINARY</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>CHAR FOR BIT DATA</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getBlob</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>BLOB</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>BLOB</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getString</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>CHAR</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>CHAR</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getClob</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>CLOB</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>CLOB</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getDate</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>DATE</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>DATE</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getBigDecimal</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>DECIMAL</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>DECIMAL</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getDouble</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>DOUBLE</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>DOUBLE PRECISION</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getDouble</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>FLOAT</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>DOUBLE PRECISION</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getInt</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>INTEGER</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>INTEGER</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getBinaryStream</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>LONGVARBINARY</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>LONG VARCHAR FOR BIT DATA</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getAsciiStream, getUnicodeStream</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>LONGVARCHAR</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>LONG VARCHAR</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getBigDecimal</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>NUMERIC</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>DECIMAL</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getFloat</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>REAL</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>REAL</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getShort</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>SMALLINT</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>SMALLINT</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getTime</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>TIME</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>TIME</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getTimestamp</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>TIMESTAMP</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>TIMESTAMP</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getBytes</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>VARBINARY</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>VARCHAR FOR BIT DATA</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">getString</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>VARCHAR</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>VARCHAR</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>None supported. You must use XMLSERIALIZE and then the
corresponding getXXX method.</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>SQLXML</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>XML</div></td></tr></tbody></table></div></div></div></div><div><a name="N1106F"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf16556"></a><div></div>Tune database booting/class loading</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">By default, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> does not boot databases (and some core <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> classes)
in the system at <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> startup but only at connection time. For multi-user
systems, you might want to reduce connection time by booting one or all databases
at startup instead.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For embedded systems, you might want to boot the database in a separate
thread (either as part of the startup, or in a connection request).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For more information, see <span style="color: blue;"><a href="#ctundepth14326">Shielding users from Derby class-loading events</a></span>.</div></div></div><div><a name="N1116A"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf16800"></a><div></div>Avoid inserts in autocommit mode if possible</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Inserts can be painfully slow in autocommit mode because each commit involves
an update of the log on the disk for each INSERT statement. The commit will
not return until a physical disk write is executed. To speed things up: <div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Run in autocommit false mode, execute a number of inserts in one transaction,
and then explicitly issue a commit.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>If your application allows an initial load into the table, you can use
the import procedures to insert data into a table. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will
not log the individual inserts when loading into an empty table using these
interfaces. See the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Tools and Utilities Guide</span></span> Guide</span> for
more information on the import procedures.</div></td></tr></table></div></div></div></div><div><a name="N11255"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperftablefunctions"></a><div></div>Improve the performance of table functions</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer makes hard-coded guesses about how to calculate the cost of a
user-written Derby-style table function. For this reason, the
optimizer may place a table function in an inefficient position in the
join order. You can give the optimizer more information so that it
makes better choices. See "Programming Derby-style table functions" in the
<span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Developer's Guide</span></span> for details.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Using restricted table functions can also improve performance greatly. See
"Writing restricted table functions" in the
<span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Developer's Guide</span></span>.</div></div></div><div><a name="N11345"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperfinmemdb"></a><div></div>Configure <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to
use an in-memory database</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If you use
<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>'s in-memory database
facility, it is important to configure the following:</div><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">The size of the Java heap.</span> The memory requirements for an in-memory
database should be similar to the memory requirements for using the file system,
plus the size of the user data.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">The <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> page cache
size.</span> For good performance, use no less than the default size of 1000 pages.
The data must pass through the page cache, even though the user data is already
stored in main memory. A larger page cache may improve performance at the
expense of increased memory usage. See
<span style="color: blue;"><a href="#ctunperf54492">Increase the size of the data page cache</a></span> for more information.</div></td></tr></table></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If you want to prevent
<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> from writing anything
to the <span style="font-style: italic;">derby.log</span> file, use one of the <span style="font-style: italic;">derby.stream.error</span>
properties (for instance, <span style="font-style: italic;">derby.stream.error.field</span>).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For more information, see "Using in-memory databases" in the
<span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Developer's Guide</span></span>.</div></div></div></div><div><a name="N1147A"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunperf31086"></a><div></div>More tips</div></div><div style="margin-left: 72pt; font-size: 10pt;"></div><div><a name="N114D4"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf17936"></a><div></div>Shut down the system properly</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> features crash recovery that restores the state of committed
transactions in the event that the database exits unexpectedly, for example
during a power failure. The recovery processing happens the next time the
database is started after the unexpected exit. Your application can reduce
the amount of work that the database has to do to start up the next time by
shutting it down in an orderly fashion. See "Shutting Down <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> or an
Individual Database" in the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Developer's Guide</span></span></span>. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> utilities all perform an "orderly" shutdown.</div></div></div><div><a name="N11548"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunperf816635"></a><div></div>Put Derby first in your classpath</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The structure of your classpath can affect <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> startup time and
the time required to load a particular class. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The classpath is searched linearly, so locate <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>'s libraries <span style="font-style: italic;">at the beginning of the classpath</span> so that they are found
first. If the classpath first points to a directory that contains multiple
files, booting <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can be very slow. </div></div></div></div></div><div><a name="N115B5"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="ctundepth39739"></a><div></div>Tuning databases and applications</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="color: blue;"><a href="#ctunperf22457">Performance tips and tricks</a></span>, provided some quick tips for
improving performance. This chapter, while covering some of the same ground,
provides more background on the basic design issues for improving performance.
It also explains how to work with RunTimeStatistics.</div></div><div><a name="N1160D"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctundepth21935"></a><div></div>Application and database design issues</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Things that you can do to improve the performance of <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> applications
fall into three categories.
</div></div><div><a name="N116B4"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctundepth10525"></a><div></div>Avoiding table scans of large tables</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is fast and efficient, but when tables are huge, scanning tables
might take longer than a user would expect. It's even worse if you then
ask <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to sort this data.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Things that you can do to avoid table scans fall into two categories.</div></div><div><a name="N11731"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth23033"></a><div></div>Always create indexes</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Have you ever thought what it would be like to look up a phone number in
the phone book of a major metropolitan city if the book were not indexed by
name? For example, to look up the phone number for John Jones, you could not
go straight to the <span style="font-style: italic;">J</span> page. You would have to read
the entire book. That is what a table scan is like. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> has to read
the entire table to retrieve what you are looking for unless you create useful
indexes on your table.</div></div><div><a name="N117D7"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth1002853"></a><div></div>Create useful indexes: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em; margin-left: 72pt;">Indexes are useful when a query contains a WHERE clause.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Without a WHERE clause, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is <span style="font-style: italic;">supposed</span> to
return all the data in the table, and so a table scan is the correct (if not
desirable) behavior. (More about that in <span style="color: blue;"><a href="#ctundepth36205">Prevent the user from issuing expensive queries</a></span>.)</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> creates indexes
on tables in the following situations:   <div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>When you define a primary key, unique, or foreign key constraint on a
table. See "CONSTRAINT clause" in the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span></span> for
more information.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>When you explicitly create an index on a table with a CREATE INDEX statement. </div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For an index to be useful for a particular statement, one of the columns
in the statement's WHERE clause must be the first column in the index's key.
  <div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  For a complete discussion of how indexes work and when they are useful,
see <span style="color: blue;"><a href="#ctunoptimz33368">What is an index?</a></span> and <span style="color: blue;"><a href="#ctunoptimz30217">Index use and access paths</a></span>.</div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Indexes provide some other benefits as well:   <div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>If all the data requested are in the index, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> does
not have to go to the table at all. (See <span style="color: blue;"><a href="#ctunoptimz30768">Covering indexes</a></span>.)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For operations that require a sort (ORDER BY), if <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> uses
the index to retrieve the data, it does not have to perform a separate sorting
step for some of these operations in some situations. (See <span style="color: blue;"><a href="#ctunoptimz27036">About the optimizer's choice of sort avoidance</a></span>.)</div></td></tr></table></div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> does
not support indexing on columns with data types like BLOB, CLOB, and XML.</div></div></div></div><div><a name="N118E3"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth1003116"></a><div></div>Make sure indexes are being used, and rebuild them: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If an index is useful for a query, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is probably using it. However,
you need to make sure. Analyze the way <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is executing your application's
queries. See <span style="color: blue;"><a href="#ttundepth33391">Analyzing statement execution</a></span> for information on
how to do this.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In addition, over time, index pages fragment. Rebuilding indexes improves
performance significantly in these situations. To rebuild an index, drop it
and then re-create it.</div></div></div><div><a name="N11975"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth1003209"></a><div></div>Think about index order: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> allows you to create index columns in descending order in addition
to creating them in ascending order, the default. Descending indexes provide
performance benefits for the following kinds of queries that require sorting data in descending order.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">To ensure performance benefits, verify that the descending index is being
used. See <span style="color: blue;"><a href="#ttundepth33391">Analyzing statement execution</a></span> for
information on how to do this. </div></div></div><div><a name="N11A05"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth1003369"></a><div></div>Think about join order: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For some queries, join order can make the difference between a table scan
(expensive) and an index scan (cheap). Here's an example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">select ht.hotel_id, ha.stay_date, ht.depart_time
from hotels ht, Hotelavailability ha
where ht.hotel_id = ha.hotel_id and 
ht.room_number = ha.room_number
and ht.bed_type = 'KING'
and ht.smoking_room = 'NO'
order by ha.stay_date</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> chooses <span style="font-style: italic;">Hotels</span> as the outer table,
it can use the index on <span style="font-style: italic;">Hotels</span> to retrieve qualifying
rows. Then it
need only look up data in <span style="font-style: italic;">HotelAvailability</span> three
times, once for each qualifying row. And to retrieve the appropriate rows
from <span style="font-style: italic;">HotelAvailability</span>, it can use an index for <span style="font-style: italic;">HotelAvailability</span>'s <span style="font-style: italic;">hotel_id</span> column
instead of scanning the entire table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> chooses the other order, with <span style="font-style: italic;">HotelAvailability</span> as the outer table, it will have to probe the <span style="font-style: italic;">Hotels</span> table for <span style="font-style: italic;">every row</span>, not just three rows, because
there are no qualifications on the <span style="font-style: italic;">HotelAvailability</span> table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For more information about join order, see <span style="color: blue;"><a href="#ctunoptimz12168">Joins and performance</a></span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> usually chooses a good join order. However, as with index use,
you should make sure. Analyze the way <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is executing your application's
queries. See <span style="color: blue;"><a href="#ttundepth33391">Analyzing statement execution</a></span> for information on
how to do this.</div></div></div><div><a name="N11AFF"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth1003672"></a><div></div>Decide whether a descending index would be useful: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> allows you to create an index that uses the descending order
for a column. Such indexes improve the performance of queries that order results
in descending order or that search for the minimum or maximum value of an
indexed column. For example, both of the following queries could benefit from
indexes that use descending ordering:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- would benefit from an index like this:
-- CREATE INDEX c_id_desc ON Citites(city_id DESC)</span>
SELECT * FROM Cities ORDER BY city_id DESC
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- would benefit from an index like this:
-- CREATE INDEX f_miles_desc on Flights(miles DESC)</span>
SELECT MAX(miles) FROM Flight
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- would benefit from an index like this:
-- CREATE INDEX arrival_time_desc ON Flights(dest_airport, arrive_time DESC)
SELECT * FROM Flights WHERE dest_airport = 'LAX'</span>
ORDER BY ARRIVAL DESC</span></div></pre></div></div></div></div><div><a name="N11B98"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth36205"></a><div></div>Prevent the user from issuing expensive queries </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Some applications have complete control over the queries that they issue;
the queries are built into the applications. Other applications allow users
to construct queries by filling in fields on a form. Any time you let users
construct ad-hoc queries, you risk the possibility that the query a user constructs
will be one like the following:   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM ExtremelyHugeTable
ORDER BY unIndexedColumn</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This statement has no WHERE clause. It will require a full table scan.
To make matters worse, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will then have to order the data. Most
likely, the user does not want to browse through all 100,000 rows, and does
not care whether the rows are all in order.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Do everything you can to avoid table scans and sorting of large results
(such as table scans).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Some things you can do to disallow such runaway queries:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Use client-side checking to make sure some minimal fields are always filled
in. Eliminate or disallow queries that cannot use indexes and are not optimizable.
In other words, force an optimizable WHERE clause by making sure that the
columns on which an index is built are included in the WHERE clause of the
query. Reduce or disallow DISTINCT clauses (which often require sorting) on
large tables.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For queries with large results, do not let the database do the ordering.
Retrieve data in chunks (provide a Next button to allow the user to retrieve
the next chunk, if desired), and order the data in the application.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Do not use SELECT DISTINCT to populate lists; instead, maintain a separate
table of the unique items.</div></td></tr></table></div></div></div></div></div><div><a name="N11C24"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctundepth29804"></a><div></div>Avoiding compiling SQL statements</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">When you submit an SQL statement to <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> compiles
and then executes the statement. <span style="font-style: italic;">Compilation</span> is a
time-consuming process that involves several steps, including optimization,
the stage in which <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> makes its statement execution plan. A statement
execution plan includes whether to use an index, the join order, and so on.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Unless there are significant changes in the amount of data in a table or
new or deleted indexes, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will probably come up with the same statement
execution plan for the same statement if you submit it more than once. This
means that the same statements should share the same plan, and <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> should
not recompile them. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> allows you to ensure this in the following
ways (in order of importance):  </div></div><div><a name="N11CC4"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth32379"></a><div></div>Using the statement cache</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The statement cache is enabled by default. You can use it to avoid extra
compilation overhead:   <div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Your application can use <span style="font-style: italic;">PreparedStatements</span> instead of <span style="font-style: italic;">Statements</span>.
  <div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="font-style: italic;">PreparedStatements</span> are JDBC objects that you prepare (compile)
once and execute multiple times. See the figure below. If your application
executes statements that are almost but not exactly alike, use <span style="font-style: italic;">PreparedStatements</span>,
which can contain dynamic or IN parameters. Instead of using the literals
for changing parameters, use question marks (?) as placeholders for such parameters.
Provide the values when you execute the statement.</div></div></td></tr></table></div><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> supports the <span style="font-style: italic;">ParameterMetaData</span> interface,
new in JDBC 3.0. This interface describes the number, type, and properties
of prepared statement parameters. See the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Developer's Guide</span></span></span> for
more information.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><div style="margin-top: 0.8em; margin-bottom: 0.8em; margin-left: 72pt;"><div style="font-weight: bold;"><span style="color: red;">Figure 1. </span>A connection need only
compile a <span style="font-style: italic;">PreparedStatement</span> once</div><span style="border-right-width: 0pt; border-left-width: 0pt;">Subsequent executions
can use the same statement execution plan even if the parameter values are
different. (<span style="font-style: italic;">PreparedStatements</span> are not shared across connections.)</span><div>&nbsp;</div><div><img src="pstmt_os.jpg" alt="This figure shows one connection with multiple executions of the same PreparedStatement, which uses the same statement execution plan."></div><div></div></div><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Even if your statement uses <span style="font-style: italic;">Statements</span> instead of <span style="font-style: italic;">PreparedStatements</span>, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can reuse the statement
execution plan for the statements from the statement cache. Statements from
any connection can share the same statement execution plan, avoiding compilation,
by using the single-statement cache. The statement cache maintains statement
plans across connections. It does not, however, maintain them across reboots.
See the figure below. <div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">When, in the same database, an application submits
an SQL <span style="font-style: italic;">Statement</span> that exactly matches one already in the cache, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> grabs the statement from
the cache, even if the <span style="font-style: italic;">Statement</span> has already been closed by the application.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">To
match exactly with a statement already in the cache, the SQL <span style="font-style: italic;">Statement</span> must
meet the following requirements:</div><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The text must match exactly</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The current schema must match</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The Unicode flag that the statement was compiled under must match the
current connection's flag</div></td></tr></table></div></div></td></tr></table></div></div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Remember: </span>  If your application executes statements that are almost
but not exactly alike, it is more efficient to use <span style="font-style: italic;">PreparedStatements</span> with
dynamic or IN parameters.  </div><div style="margin-top: 0.8em; margin-bottom: 0.8em; margin-left: -72pt;"><div style="font-weight: bold;"><span style="color: red;">Figure 2. </span>A database can reuse a statement
execution plan when the SQL text matches a prior statement <span style="font-style: italic;">exactly</span></div><span style="border-right-width: 0pt; border-left-width: 0pt;">(<span style="font-style: italic;">PreparedStatements</span> are much more efficient.)</span><div>&nbsp;</div><div style="text-align: center;"><img src="stmt_os.jpg" alt="This figure shows how Derby can reuse a statement execution plan that is already in the statement cache, even when the statement is executed from a different connection."></div><div></div></div></div></div></div><div><a name="N11E07"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctundepth14326"></a><div></div>Shielding users from Derby class-loading events</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">JVMs tend to load classes as they are needed, which means the first time
you need a class in a piece of software, it takes longer to use.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> has three clear
cases when a lot of class loading occurs:   <div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">When the system boots</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The system boots when you load the embedded
driver, <span style="font-style: italic;">org.apache.derby.</span><span style="font-style: italic;">jdbc.EmbeddedDriver</span>. In a server framework,
the system boots when you start the server framework. Booting <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> loads
basic <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> classes.</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">When the first database boots</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Booting the first database loads
some more <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> classes.
The default behavior is that the first database boots when the first connection
is made to it. You can also configure the system to boot databases at startup.
Depending on your application, one or the other might be preferable. </div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">When you compile the first query</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Compiling the first query
loads additional classes.</div></div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For any of these events, you can control the impact they have on users
by starting them in separate threads while other tasks are occurring.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In addition, if you are using <span style="font-style: italic;">PreparedStatements</span>, prepare them in
a separate thread in the background while other tasks are occurring.</div><div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="font-weight: bold;">Tuning tips for multi-user systems</span><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For concurrency, use row-level locking and the READ_COMMITTED isolation
level.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For read-only applications, use table-level locking and the READ_COMMITTED
isolation level.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Boot databases at startup to minimize the impact of connecting.</div></td></tr></table></div></div></div></td></tr></tbody></table></div><div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="font-weight: bold;">Tuning tips for single-user systems</span><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> boots when you
first load the embedded JDBC driver (<span style="font-style: italic;">org.apache.derby.</span><span style="font-style: italic;">jdbc.EmbeddedDriver</span>).
Load this driver during the least time-sensitive portion of your program,
such as when it is booting or when you are waiting for user input. For server
frameworks, the driver is loaded automatically when the server boots.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Boot the database at connection (the default behavior), not at startup.
Connect in a background thread if possible.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Turn off row-level locking and use READ_COMMITTED isolation level.</div></td></tr></table></div></div></div></td></tr></tbody></table></div></div></div></div><div><a name="N11F55"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ttundepth33391"></a><div></div>Analyzing statement execution</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N11F97"></a><span></span> After you create indexes, make sure that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is
using them. In addition, you might also want to find out the join order <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is choosing.<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A general
plan of attack for analyzing your application's SQL statements:</div></div><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div>1. 
          </div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">Collect your application's most frequently used SQL statements
and transactions into a single test.</span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div>2. 
          </div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">Create a benchmark test suite against which to run the sample queries.
The first thing the test suite should do is checkpoint data (force <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to
flush data to disk). You can do that with the following JDBC code: </span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">CallableStatement cs = conn.prepareCall
("CALL SYSCS_UTIL.SYSCS_CHECKPOINT_DATABASE()");
cs.execute();
cs.close();</div></pre></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div>3. 
          </div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">Use performance timings to identify poorly performing queries.
Try to distinguish between cached and uncached data. Focus on measuring operations
on uncached data (data not already in memory). For example, the first time
you run a query, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> returns
uncached data. If you run the same query immediately afterward, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is
probably returning cached data. The performance of these two otherwise identical
statements varies significantly and skews results.</span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div>4. 
          </div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">Use RunTimeStatistics to identify tables that are scanned excessively.
Check that the appropriate indexes are being used to satisfy the query and
that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is choosing
the best join order.  You can also set <span style="font-style: italic;">derby.language.logQueryPlan</span> to true
to check whether indexes are being used or not. This property will  is print
query plans in the <span style="font-style: italic;">derby.log</span> file. See the
"<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> properties" section of
the <span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span> for details on this property.
See <span style="color: blue;"><a href="#ctundepth13055">Working with RunTimeStatistics</a></span> for more
information.</span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div>5. 
          </div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">Make any necessary changes and then repeat.</span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div>6. 
          </div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">If changing data access does not create significant improvements,
consider other database design changes, such as denormalizing data to reduce
the number of joins required. Then review the tips in <span style="color: blue;"><a href="#ctundepth21935">Application and database design issues</a></span>.</span></div></td></tr></table></div></div></div><div><a name="N1206F"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctundepth13055"></a><div></div>Working with RunTimeStatistics</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> provides a language-level tool for evaluating the performance
and the execution plans of statements, the RUNTIMESTATISTICS attribute.  
</div></div><div><a name="N1210F"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctundepth26674"></a><div></div>Overview</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">When RUNTIMESTATISTICS is turned on for a connection, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> maintains
information about the execution plan for each statement executed within the
connection (except for COMMIT) until the attribute is turned off.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For the most recently executed query, RUNTIMESTATISTICS returns information
about:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">the length of the compile time and the execute time.</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This can help in benchmarking queries.</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;">the statement execution plan.</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This is a description
of result set nodes, whether an index was used, what the join order was, how
many rows qualified at each node, and how much time was spent in each node.
This information can help you determine whether you need to add indexes or
rewrite queries.</div></div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The exact details presented, as well as the format of presentation, can
    change. There are two techniques for retrieving the RUNTIMESTATISTICS
    information:
    <div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>call SYSCS_UTIL.SYSCS_GET_RUNTIMESTATISTICS, which retrieves
            the RUNTIMESTATISTICS information as formatted text</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>call SYSCS_UTIL.SYSCS_SET_XPLAIN_SCHEMA before executing your
            statements, which causes 
            <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>
            to store the RUNTIMESTATISTICS information in the SYSXPLAIN 
            database tables, which can then be queried 
            later to retrieve the data.</div></td></tr></table></div></div></div></div><div><a name="N121BF"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ttundepth34375"></a><div></div>How you use the RUNTIMESTATISTICS attribute</div><div style="margin-left: 72pt; font-size: 10pt;"><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">To use the RUNTIMESTATISTICS attribute in <span style="font-family: Courier;">ij</span>,
turn on and off RUNTIMESTATISTICS using the <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS()</span> system
procedure (see the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span></span> for more information):</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">-- turn on RUNTIMESTATISTICS for connection:
<span style="font-weight: bold;">CALL SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS(1);</span>
-- execute complex query here -- step through the result set
-- access runtime statistics information:
<span style="font-weight: bold;">VALUES SYSCS_UTIL.SYSCS_GET_RUNTIMESTATISTICS();</span>
<span style="font-weight: bold;">CALL SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS(0);</span></div></pre></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="border-right-width: 0pt; border-left-width: 0pt;">Turn on statistics timing using the <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_SET_STATISTICS_TIMING</span> system
procedure (see the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span></span> for more information).
If you do not turn on statistics timing, you will see the statement execution
plan only, and not the timing information.</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">CALL SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS(1);
CALL SYSCS_UTIL.SYSCS_SET_STATISTICS_TIMING(1);</div></pre></div></div></td></tr></table></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N12247"></a><span></span>Although the syntax is different, the basic steps for working with
RUNTIMESTATISTICS are the same in a Java program.</div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1224C"></a><span></span>If you are working in <span style="font-family: Courier;">ij</span>, set the display
width to 5000 or another high number:<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">MaximumDisplayWidth 5000</span></div></pre></div></div></div><div><a name="N122A9"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctun_xplain_style"></a><div></div>How you use the XPLAIN style</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N122C8"></a><span></span><div style="font-weight: bold;">Overview</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
        XPLAIN style is an enhanced form of RUNTIMESTATISTICS processing
        which preserves captured statistics information in 
        <span style="color: blue;"><a href="#ctun_xplain_tables">database 
            tables</a></span>.
        Once the statistics have been collected and saved in the 
        tables, they can be queried for analysis purposes.
    </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
        Note that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>
        spells XPLAIN without the initial 'E'. This is done
        to help distinguish the
        <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>
        functionality from the explain
        functionality that you might be familiar with from commercial DBMS
        products. The current XPLAIN implementation is optimized for
        ad-hoc queries and tool support. Furthermore, the explain data
        is quite extensive to analyze. 
        <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>
        tries to implement a
        compromise between detailed explain information which is
        almost unreadable by human users and which has to be evaluated
        with the help of a tool, versus a compact version of explain
        data which is only applicable for rough investigations but
        is still browseable by human users. We feel that the information
        in the XPLAIN system tables is sufficiently detailed to be powerful,
        but still simple enough to provide useful information to
        ad-hoc querying during interactive use.
    </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
    To use XPLAIN style, first turn on RUNTIMESTATISTICS using the
            <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS()</span> system
            procedure.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Optionally, turn on statistics timing using the
            <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_SET_STATISTICS_TIMING</span>
            system procedure.  If you do not turn on statistics timing,
            you will see the statement execution
            plan only, and not the timing information.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Next, to activate XPLAIN style, use the
            <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_SET_XPLAIN_SCHEMA()</span> system
        procedure:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">-- turn on RUNTIMESTATISTICS for connection:
<span style="font-weight: bold;">CALL SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS(1);</span>
<span style="font-weight: bold;">CALL SYSCS_UTIL.SYSCS_SET_STATISTICS_TIMING(1);</span>
-- Indicate that statistics information should be captured into
-- database tables in the MYSCHEMA schema:
<span style="font-weight: bold;">CALL SYSCS_UTIL.SYSCS_SET_XPLAIN_SCHEMA('MYSCHEMA');</span>
--execute queries, step through result sets, perform application processing...
<span style="font-weight: bold;">CALL SYSCS_UTIL.SYSCS_SET_RUNTIMESTATISTICS(0);</span></div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Although the syntax is different, the basic steps for working with
    XPLAIN style are the same in a Java program.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">XPLAIN style is further refined by the use of XPLAIN-only mode. By
    default, XPLAIN-only mode is off, which means that statements are
    compiled and executed normally. When XPLAIN-only mode is on, statements
    are compiled, but not executed. This is useful for investigating what
    query plan has been selected for a statement, without actually
    executing the statement. To activate XPLAIN-only mode, use the
    <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_SET_XPLAIN_MODE()</span> system procedure:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
    call SYSCS_UTIL.SYSCS_SET_XPLAIN_MODE(1);
</div></pre></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N12348"></a><span></span><div style="font-weight: bold;">Examples</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Some examples of usage follow.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Retrieve the text of statements
        which were captured, in order by the time when the statistics were
    captured:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
    select stmt_text, xplain_time from myschema.sysxplain_statements
    order by xplain_time
</div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Retrieve the text of statements which were captured, showing the
    statements which took the longest time to execute first:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
    select s.stmt_text, st.execute_time from myschema.sysxplain_statements s,
           myschema.sysxplain_statement_timings st
    where s.timing_id = st.timing_id
    order by st.execute_time desc
</div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Show the statements that were executed, together with the result sets
    that each statement required:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
    select st.stmt_text, rs.op_identifier 
    from myschema.sysxplain_statements st
    join myschema.sysxplain_resultsets rs
         on st.stmt_id = rs.stmt_id
</div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Find statements which resulted in an external sort being performed:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
    select s.stmt_text, s.stmt_id, rs.op_identifier, srt.no_input_rows
    from myschema.sysxplain_sort_props srt,
         myschema.sysxplain_resultsets rs,
         myschema.sysxplain_statements s
    where rs.stmt_id = s.stmt_id and rs.sort_rs_id = srt.sort_rs_id
          and srt.sort_type = 'EX'
</div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Show statements which resulted in a sort, sorted by the number of
    rows which were sorted by that statement.</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
    select s.stmt_text, s.stmt_id, rs.op_identifier, srt.no_input_rows
    from myschema.sysxplain_sort_props srt,
         myschema.sysxplain_resultsets rs,
         myschema.sysxplain_statements s
    where rs.stmt_id = s.stmt_id and rs.sort_rs_id = srt.sort_rs_id
    order by srt.no_input_rows desc
</div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Find statements which resulted in a tablescan of the COUNTRIES table,
    and display the number of pages and rows that were visited by each scan:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
    select st.stmt_text, sp.no_visited_pages, sp.no_visited_rows 
    from myschema.sysxplain_scan_props sp, 
         myschema.sysxplain_resultsets rs, 
         myschema.sysxplain_statements st 
    where st.stmt_id = rs.stmt_id and 
          rs.scan_rs_id = sp.scan_rs_id and 
          rs.op_identifier = 'TABLESCAN' and 
          sp.scan_object_name = 'COUNTRIES'
</div></pre></div></div></div><div><a name="N123E0"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctundepth37648"></a><div></div>Analyzing the information</div><div style="margin-left: 72pt; font-size: 10pt;"></div><div><a name="N12480"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth853095"></a><div></div>Statistics timing</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If you are using statistics timing, RUNTIMESTATISTICS provides information
about how long each stage of the statement took. An SQL statement has
two basic stages within <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>: compilation and execution. Compilation
is the work done while the statement is prepared. Compilation is composed
of the following stages: parsing, binding, optimization, and code generation.
Execution is the actual evaluation of the statement.</div></div></div><div><a name="N12500"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth853133"></a><div></div>Statement execution plan</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">RUNTIMESTATISTICS also provides information about the <span style="font-style: italic;">statement execution
plan</span>. The statement execution plan shows how long each node took to evaluate,
how many rows were retrieved, whether an index was used, and so on. If an
index was used, it shows the start and stop positions for the matching index
scan. Looking at the plan can help you determine whether to add an index or
to rewrite the query.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A statement execution plan is composed of a tree of result set nodes. A
result set node represents the evaluation of one portion of the statement;
it returns rows to a calling (or parent) node and can receive rows from a
child node. A node can have one or more children. Starting from the top, if
a node has children, it requests rows from the children. Usually only the
execution plans of DML statements (queries, inserts, updates, and deletes,
not dictionary object creation) are composed of more than one node.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, consider the following query:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Countries</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">This simple query involves one node only-reading all the data out of the <span style="font-style: italic;">Countries</span> table.
It involves a single node with no children. This result set node is called
a <span style="font-style: italic;">Table Scan ResultSet</span>. RUNTIMESTATISTICS text for this node looks
something like this:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">
Statement Name:
        null
Statement Text:
        select * from countries
Parse Time: 20
Bind Time: 10
Optimize Time: 50
Generate Time: 20
Compile Time: 100
Execute Time: 10
Begin Compilation Timestamp : 2005-05-25 09:16:21.24
End Compilation Timestamp : 2005-05-25 09:16:21.34
Begin Execution Timestamp : 2005-05-25 09:16:21.35
End Execution Timestamp : 2005-05-25 09:16:21.4
Statement Execution Plan Text:
Table Scan ResultSet for COUNTRIES at read committed isolation
level using instntaneous share row 
locking chosen by the optimizer
Number of opens = 1
Rows seen = 114
Rows filtered = 0
Fetch Size = 16
        constructor time (milliseconds) = 0
        open time (milliseconds) = 0
        next time (milliseconds) = 10
        close time (milliseconds) = 0
        next time in milliseconds/row = 0

scan information:
        Bit set of columns fetched=All
        Number of columns fetched=3
        Number of pages visited=3
        Number of rows qualified=114
        Number of rows visited=114
        Scan type=heap
        start position:
null    stop position:
null    qualifiers:
None
        optimizer estimated row count:          119.00
        optimizer estimated cost:           69.35
</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Consider this second, more complex query:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;"></span>SELECT Country
FROM Countries
WHERE Region = 'Central America'</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When executed, this query involves two nodes- one to retrieve
qualifying rows (the restriction is done at this node) and one to project
the requested columns. So, at bottom, there is a <span style="font-style: italic;">TableScanResultSet</span> for
scanning the table. The qualifier (Region = 'Central America') is evaluated
in this node. These data are passed up to the parent node, called a <span style="font-style: italic;">Project-Restrict
ResultSet</span>, in which the rows are projected-only the <span style="font-style: italic;">country</span> column
is needed (the first column in the table). RUNTIMESTATISTICS text for these
two nodes looks something like this:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">Statement Name:
        null
Statement Text:
        SELECT Country FROM Countries WHERE Region = 'Central America'
Parse Time: 10
Bind Time: 0
Optimize Time: 370
Generate Time: 10
Compile Time: 390
Execute Time: 0
Begin Compilation Timestamp : 2005-05-25 09:20:41.274
End Compilation Timestamp : 2005-05-25 09:20:41.664
Begin Execution Timestamp : 2005-05-25 09:20:41.674
End Execution Timestamp : 2005-05-25 09:20:41.674
Statement Execution Plan Text:
Project-Restrict ResultSet (2):
Number of opens = 1
Rows seen = 6
Rows filtered = 0
restriction = false
projection = true
        constructor time (milliseconds) = 0
        open time (milliseconds) = 0
        next time (milliseconds) = 0
        close time (milliseconds) = 0
        restriction time (milliseconds) = 0
        projection time (milliseconds) = 0
        optimizer estimated row count:           11.90
        optimizer estimated cost:           69.35

Source result set:
        Table Scan ResultSet for COUNTRIES at read committed isolation level
using instantaneous share row locking chosen by the optimizer
        Number of opens = 1
        Rows seen = 6
        Rows filtered = 0
        Fetch Size = 16
                constructor time (milliseconds) = 0
                open time (milliseconds) = 10
                next time (milliseconds) = 0
                close time (milliseconds) = 0
                next time in milliseconds/row = 0

        scan information:
                Bit set of columns fetched={0, 2}
                Number of columns fetched=2
                Number of pages visited=3
                Number of rows qualified=6
                Number of rows visited=114
                Scan type=heap
                start position:
null            stop position:
null            qualifiers:
Column[0][0] Id: 2
Operator: =
Ordered nulls: false
Unknown return value: false
Negate comparison result: false

                optimizer estimated row count:           11.90
                optimizer estimated cost:           69.35
</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Other, more complex queries such as joins and unions have other types of
result set nodes.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For inserts, updates, and deletes, rows flow out of the top, where they
are inserted, updated, or deleted. For selects (queries), rows flow out of
the top into a result set that is returned to the user.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span></span> shows the
many possible <span style="font-style: italic;">ResultSet</span> nodes that might appear in an execution plan. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In addition, read <span style="color: blue;"><a href="#ctunoptimz39739">DML statements and performance</a></span>,
for more information about some of the ways in which <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> executes statements.</div></div></div><div><a name="N1260C"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepth853228"></a><div></div>Optimizer estimates</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">RUNTIMESTATISTICS show the optimizer estimates for a particular node. They
show the optimizer's estimated row count and the optimizer's "estimated
cost."</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The <span style="font-style: italic;">estimated row count</span> is the query optimizer's
estimate of the number of qualifying rows for the table or index for the entire
life of the query. If the table is the inner table of a join, the estimated
row count will be for all the scans of the table, not just for a single scan
of the table.  </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The <span style="font-style: italic;">estimated cost</span> consists of a number, which
is a relative number; it does not correspond directly to any time estimate.
It is not, for example, the number of milliseconds or rows. Instead, the optimizer
constructs this number for each possible access path. It compares the numbers
and chooses the access path with the smallest number.</div></div></div><div><a name="N1268A"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctundepthoptover"></a><div></div>Optimizer overrides</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">RUNTIMESTATISTICS provides information about user-specified optimizer hints
that were specified by using a  -- DERBY-PROPERTIES clause.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following example shows a SELECT statement in which the optimizer was
forced to use a particular index:<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM t1 -- DERBY-PROPERTIES index = t1_c1 
FOR UPDATE OF c2, c1</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">RUNTIMESTATISTICS returns the following information about this statement:<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">Statement Name: 
		 null
Statement Text: select * from t1 --DERBY-PROPERTIES index = t1_c1 
for update of c2, c1


Parse Time: 0
Bind Time: 0
Optimize Time: 0
Generate Time: 0
Compile Time: 0
Execute Time: 0
Begin Compilation Timestamp : null
End Compilation Timestamp : null
Begin Execution Timestamp : null
End Execution Timestamp : null
Statement Execution Plan Text: 
Index Row to Base Row ResultSet for T1:
Number of opens = 1
Rows seen = 4
Columns accessed from heap = {0, 1, 2}
		 constructor time (milliseconds) = 0
		 open time (milliseconds) = 0
		 next time (milliseconds) = 0
		 close time (milliseconds) = 0
                 User supplied optimizer overrides on T1 are { index=T1_C1 }
		 Index Scan ResultSet for T1 using index T1_C1 at read committed isolation level 
                 using exclusive row locking chosen by the optimizer
		 Number of opens = 1
		 Rows seen = 4
		 Rows filtered = 0
		 Fetch Size = 1
		 		 constructor time (milliseconds) = 0
		 		 open time (milliseconds) = 0
		 		 next time (milliseconds) = 0
		 		 close time (milliseconds) = 0
		 		 next time in milliseconds/row = 0
		 scan information: 
		 		 Bit set of columns fetched=All
		 		 Number of columns fetched=2
		 		 Number of deleted rows visited=0
		 		 Number of pages visited=1
		 		 Number of rows qualified=4
		 		 Number of rows visited=4
		 		 Scan type=btree
		 		 Tree height=1
		 		 start position: 
		 None
		 		 stop position: 
		 None
		 		 qualifiers:
None

</div></pre></div></div></div><div><a name="N12708"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctun_xplain_tables"></a><div></div>Understanding XPLAIN style database tables</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
        XPLAIN style is an enhanced form of RUNTIMESTATISTICS processing
        which preserves captured statistics information in database tables.
        Once the statistics have been collected and saved in the 
        tables, they can be queried for analysis purposes.
    </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
        Rows accumulate in the SYSXPLAIN_* database tables until you 
        empty the tables by dropping them or executing DELETE FROM statements
        against them.
    </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
        Note that, although these tables have stylized names which all
        start with the prefix "SYSXPLAIN_*", they are not in fact special
        system catalogs, but are merely ordinary database tables, which
        can be accessed in all the standard ways that any other database
        table is accessed. The tables are automatically created if they
        are not present when statistics are being captured. The tables
        are all located in a particular schema which is specified by the
        <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_SET_XPLAIN_SCHEMA()</span> system procedure.
    </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
        The XPLAIN style database tables are summarized here. For more
        information about the structure and content of each table,
        see "XPLAIN style tables" in
        the <span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span>.
    </div><div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">SYSXPLAIN_STATEMENTS</span></div><div style="margin-left: 72pt + 16pt;">This table contains one row for each statement which
            has had statistics captured. This row contains the text of the
            statement, as well as identifiers which can be used to join with
            the other tables to find more data about how this statement was
            executed.
        </div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">SYSXPLAIN_RESULTSETS</span></div><div style="margin-left: 72pt + 16pt;">This table contains one row for each result set which
            was used during the execution of a particular explained statement.
            Most queries have one or several result sets; some complex queries
        can have many result sets.
        </div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">SYSXPLAIN_SCAN_PROPS</span></div><div style="margin-left: 72pt + 16pt;">This table contains one row for each result set which
            performed a scan of a table, index, or constraint. Using the
            information in this row, you can determine how much data needed
        to be examined by the scan.
        </div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">SYSXPLAIN_SORT_PROPS</span></div><div style="margin-left: 72pt + 16pt;">This table contains one row for each result set which
            performed a sort of data. Using the information in this row, you
        can determine how much data needed to be sorted.
        </div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">SYSXPLAIN_STATEMENT_TIMINGS</span></div><div style="margin-left: 72pt + 16pt;">This table contains timing information at the statement
            level. Timing information is optional, but if it is captured, the
            data in this table can be used to determine how much time each
        statement took.
        </div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">SYSXPLAIN_RESULTSET_TIMINGS</span></div><div style="margin-left: 72pt + 16pt;">This table contains timing information at the result set
            level. Timing information is optional, but if it is captured, the
            data in this table can be used to determine how much time each
        result set took.
        </div></div></div></div></div></div></div></div><div><a name="N127F4"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="ctunoptimz39739"></a><div></div>DML statements and performance</div></div><div style="margin-left: 72pt; font-size: 10pt;"></div><div><a name="N1284E"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunoptimz23977"></a><div></div>Performance and optimization</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A DBMS often has a choice about the access path for retrieving data. For
example, the DBMS can use an index (fast lookup for specific entries) or scan
the entire table to retrieve the appropriate rows. In addition, in statements
in which two tables are joined, the DBMS can choose which table to examine
first (join order) and how to join the tables (join strategy). <span style="font-style: italic;">Optimization</span> means that DBMS makes the best (optimal) choice of access
paths, join order, and join strategy. True query optimization means that the
DBMS will usually make a good choice regardless of how the query is written.
The optimizer does not necessarily make the <span style="font-style: italic;">best</span> choice,
just a good one.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can use indexes to improve the performance of DML (data manipulation
language) statements such as queries, updates, and deletes. The query optimizer
can make decisions about whether to use an index for a particular table (access
path) and also makes decisions about join order, type of join, and a few other
matters.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This section gives an overview of the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> optimizer and discusses
performance issues in the execution of DML statements.</div></div><div><a name="N1291E"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunoptimz30217"></a><div></div>Index use and access paths</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If you define an index on a column or columns, the query optimizer can
use the index to find data in the column more quickly. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> automatically
creates indexes to back up primary key, foreign key, and unique constraints,
so those indexes are always available to the optimizer, as well as those that
you explicitly create with the CREATE INDEX command. The way <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> gets
to the data-via an index or directly via the table-is called the <span style="font-style: italic;">access path</span>.</div></div><div><a name="N129D5"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz33368"></a><div></div>What is an index?</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">An index is a database structure that provides quick lookup of data in
a column or columns of a table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, a <span style="font-style: italic;">Flights</span> table in a <span style="font-style: italic;">travelDB</span> database has three indexes:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>An index on the <span style="font-style: italic;">orig_airport</span> column (called <span style="font-style: italic;">OrigIndex</span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>An index on the <span style="font-style: italic;">dest_airport</span> column (called <span style="font-style: italic;">DestIndex</span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>An index enforcing the <span style="font-style: italic;">primary key</span> constraint
on the <span style="font-style: italic;">flight_id</span> and <span style="font-style: italic;">segment_number</span> columns (which has a system-generated name)</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This means there are three separate structures that provide shortcuts into
the <span style="font-style: italic;">Flights</span> table. Let's look at one of those
structures, <span style="font-style: italic;">OrigIndex</span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="font-style: italic;">OrigIndex</span> stores every value in the <span style="font-style: italic;">orig_airport</span> column, plus information on how to retrieve the entire corresponding
row for each value.   
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For every row in <span style="font-style: italic;">Flights</span>, there is an entry in <span style="font-style: italic;">OrigIndex</span> that includes the value of the <span style="font-style: italic;">orig_airport</span> column and the address of the row itself. The entries are
stored in ascending order by the <span style="font-style: italic;">orig_airport</span> values.</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When an index includes more than one column, the first column is the main
one by which the entries are ordered. For example, the index on (<span style="font-style: italic;">flight_id</span>, <span style="font-style: italic;">segment_number</span>) is ordered first by <span style="font-style: italic;">flight_id</span>. If there is more than one <span style="font-style: italic;">flight_id</span> of the same value, those entries are then ordered by <span style="font-style: italic;">segment_number</span>. An excerpt from the entries in the index might look like
this:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">'AA1111' 1
'AA1111' 2
'AA1112' 1
'AA1113' 1
'AA1113' 2</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Indexes are helpful only sometimes. This particular index is useful when
a statement's WHERE clause is looking for rows for which the value of <span style="font-style: italic;">orig_airport</span> is some specific value or range of values.
SELECTs, UPDATEs, and DELETEs can all have WHERE clauses.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, <span style="font-style: italic;">OrigIndex</span> is helpful for statements
such as the following:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM Flights
WHERE orig_airport = 'SFO'

SELECT *
FROM Flights
WHERE orig_airport &lt; 'BBB'

SELECT *
FROM Flights
WHERE orig_airport &gt;= 'MMM'</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="font-style: italic;">DestIndex</span> is helpful for statements such as the
following:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM Flights
WHERE dest_airport = 'SCL'</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The primary key index (on <span style="font-style: italic;">flight_id</span> and <span style="font-style: italic;">segment_number</span>) is helpful for statements such as the following:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM Flights
WHERE flight_id = 'AA1111'

SELECT *
FROM Flights
WHERE flight_id BETWEEN 'AA1111' AND 'AA1115'

SELECT *
FROM FlightAvailability AS fa, Flights AS fts
WHERE flight_date &gt; CURRENT_DATE
AND fts.flight_id = fa.flight_id
AND fts.segment_number = fa.segment_number</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The next section discusses why the indexes are helpful for these statements
but not for others.</div></div></div><div><a name="N12B74"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz39106"></a><div></div>What's optimizable?</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">As you learned in the previous section, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> might be able to use
an index on a column to find data more quickly. If <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can use an
index for a statement, that statement is said to be <span style="font-style: italic;">optimizable</span>. The statements shown in the preceding section allow <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to
use the index because their WHERE clauses provide start and stop conditions.
That is, they tell <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> the point at which to begin its scan of the
index and where to end the scan.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For example, a statement with a WHERE clause looking for rows for which
the <span style="font-style: italic;">orig_airport</span> value is less than <span style="font-style: italic;">BBB</span> means that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> must begin the scan at the beginning of the
index; it can end the scan at <span style="font-style: italic;">BBB</span>. This means that
it avoids scanning the index for most of the entries.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">An index scan that uses start or stop conditions is called a <span style="font-style: italic;">matching index scan</span>.  
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  A WHERE clause can have more than
one part. Parts are linked with the word <span style="font-style: italic;">AND</span> or <span style="font-style: italic;">OR</span>. Each part is called a <span style="font-style: italic;">predicate</span>. WHERE clauses with predicates joined by OR are not optimizable. WHERE
clauses with predicates joined by AND are optimizable if <span style="font-style: italic;">at least one</span> of the predicates is optimizable. For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights
WHERE flight_id = 'AA1111' AND
segment_number &lt;&gt; 2</span></div></pre></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">In this example, the first predicate is optimizable; the second predicate
is not. Therefore, the statement is optimizable.  
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  In a few
cases, a WHERE clause with predicates joined by OR can be transformed into
an optimizable statement. See <span style="color: blue;"><a href="#rtuntransform590">OR transformations</a></span>.</div></div></div><div><a name="N12CAA"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz24840"></a><div></div>Directly optimizable predicates: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Some predicates provide clear-cut starting and stopping points. A predicate
provides start or stop conditions, and is therefore optimizable, when:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>It uses a simple column reference to a column (the name of the column,
not the name of the column within an expression or method call). For example,
the following is a simple column reference:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">WHERE orig_airport = 'SFO'</span></div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following is not:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">WHERE lower(orig_airport) = 'sfo'</span></div></pre></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>It refers to a column that is the first or only column in the index.  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">References to <span style="font-style: italic;">contiguous</span> columns in other predicates
in the statement when there is a multi-column index can further define the
starting or stopping points. (If the columns are not contiguous with the first
column, they are not optimizable predicates but can be used as <span style="font-style: italic;">qualifiers</span>.) For example, given a composite index on <span style="font-style: italic;">FlightAvailability</span> (<span style="font-style: italic;">flight_id</span>, <span style="font-style: italic;">segment_number,</span> and <span style="font-style: italic;">flight_date</span>), the following
predicate satisfies that condition:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">WHERE flight_id = 'AA1200' AND segment_number = 2</span></div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following
one does not:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">WHERE flight_id = 'AA1200' AND flight_date = CURRENT_DATE</span></div></pre></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The column is compared to a <span style="font-style: italic;">constant</span> or to an
expression that does not include columns in the same table. Examples of valid
expressions: <span style="font-style: italic;">other_table.column_a</span>, <span style="font-style: italic;">?</span> (dynamic parameter), <span style="font-style: italic;">7+9</span>. The comparison
must use the following operators:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>=</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&lt;</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&lt;=</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&gt;</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&gt;=</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>IS NULL</div></td></tr></table></div></div></td></tr></table></div></div></div></div><div><a name="N12DD3"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz1004264"></a><div></div>Indirectly optimizable predicates: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Some predicates are transformed internally into ones that provide starting
and stopping points and are therefore optimizable.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Predicates that use the following comparison operators can be transformed
internally into optimizable predicates:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>BETWEEN</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>LIKE (in certain situations)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>IN (in certain situations)</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For details on these and other transformations, see <span style="color: blue;"><a href="#ctuntransform13966">Internal language transformations</a></span>.</div></div></div><div><a name="N12E5B"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz1004373"></a><div></div>Joins: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Joins specified by the JOIN keyword are optimizable. This means that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can
use an index on the inner table of the join (start and stop conditions are
being supplied implicitly by the rows in the outer table).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Note that joins built using traditional predicates are also optimizable.
For example, the following statement is optimizable:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Countries, Cities
WHERE Countries.country_ISO_code = Cities.country_ISO_code</span></div></pre></div></div></div></div><div><a name="N12ECE"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz30768"></a><div></div>Covering indexes</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Even when there is no definite starting or stopping point for an index
scan, an index can speed up the execution of a query if the index covers the
query. An index <span style="font-style: italic;">covers the query</span> if all the columns
specified in the query are part of the index. These are the columns that are
all columns referenced in the query, not just columns in a WHERE clause. If
so, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> never has to go to the data pages at all, but can retrieve
all data through index access alone. For example, in the following queries, <span style="font-style: italic;">OrigIndex</span> covers the query:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT orig_airport
FROM Flights

SELECT DISTINCT lower(orig_airport) FROM Flights 
FROM Flights</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can get all required data out of the index instead of from
the table.</div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  If the query produces an updatable result set, 
<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will retrieve all 
data from the data pages even if there is an index that covers the query.</div></div><div><a name="N12FA3"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="rtunoptimz1004602"></a><div></div>Single-column index examples: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N12FB0"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following queries do <span style="font-style: italic;">not</span> provide start and
stop conditions for a scan of <span style="font-style: italic;">OrigIndex</span>, the index
on the <span style="font-style: italic;">orig_airport</span> column in <span style="font-style: italic;">Flights.</span> However, some of these queries allow <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to do an index
rather than a table scan because the index covers the query.  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>  would scan entire table; comparison is not with a 
-- constant or with a column in another table</span>
SELECT *
FROM Flights
WHERE orig_airport = dest_airport
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>  would scan entire table; &lt;&gt; operator is not optimizable</span>
SELECT *
FROM Flights
WHERE orig_airport &lt;&gt; 'SFO'
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- not valid operator for matching index scan
-- However, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>  would do an index 
-- rather than a table scan because
-- index covers query</span>
SELECT orig_airport
FROM Flights
WHERE orig_airport &lt;&gt; 'SFO'
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- use of a function is not simple column reference
-- <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>  would scan entire index, but not table
-- (index covers query)</span>
SELECT orig_airport
FROM Flights
WHERE lower(orig_airport) = 'sfo'</span></div></pre></div></div></div></div><div><a name="N1303C"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="rtunoptimz1004810"></a><div></div>Multiple-column index example: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N13049"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following queries do provide start and stop conditions for a scan of
the primary key index on the <span style="font-style: italic;">flight_id</span> and <span style="font-style: italic;">segment_number</span> columns in <span style="font-style: italic;">Flights</span>:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- the where clause compares both columns with valid
-- operators to constants</span>
SELECT *
FROM Flights
WHERE flight_id = 'AA1115'
AND segment_number &lt; 2
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- the first column is in a valid comparison</span>
SELECT *
FROM Flights
WHERE flight_id &lt; 'BB'
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- LIKE is transformed into &gt;= and &lt;=, providing
-- start and stop conditions</span>
SELECT *
FROM Flights
WHERE flight_id LIKE 'AA%'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1307F"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following queries do not:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- segment_number is in the index, but it's not the first column;
-- there's no logical starting and stopping place</span>
SELECT *
FROM Flights
WHERE segment_number = 2
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>  would scan entire table; comparison of first column
-- is not with a constant or column in another table
-- and no covering index applies</span>
SELECT *
FROM Flights
WHERE orig_airport = dest_airport
AND segment_number &lt; 2</span></div></pre></div></div></div></div></div><div><a name="N130CF"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz41314"></a><div></div>Useful indexes can use qualifiers</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Matching index scans can use qualifiers that further restrict the result
set. Remember that a WHERE clause that contains at least one optimizable predicate
is optimizable. Nonoptimizable predicates can be useful in other ways.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Consider the following query:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM FLIGHTS
WHERE orig_airport &lt; 'BBB'
AND orig_airport &lt;&gt; 'AKL'</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The second predicate is not optimizable, but the first predicate is. The
second predicate becomes a qualification for which <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> evaluates the
entries in the index as it traverses it.  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The following comparisons are valid qualifiers:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>=</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&lt;</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&lt;=</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&gt;</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&gt;=</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>IS NULL</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>BETWEEN</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>LIKE</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>&lt;&gt;</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>IS NOT NULL</div></td></tr></table></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The qualifier's reference to the column does not have to be a simple
column reference; you can put the column in an expression.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The qualifier's column does not have to be the first column in the
index and does not have to be contiguous with the first column in the index.</div></td></tr></table></div></div></div></div><div><a name="N131BA"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz22900"></a><div></div>When a table scan Is better</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Sometimes a table scan is the most efficient way to access data, even if
a potentially useful index is available. For example, if the statement returns
virtually all the data in the table, it is more efficient to go straight to
the table instead of looking values up in an index, because then <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is
able to avoid the intermediate step of retrieving the rows from the index
lookup values.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM Flights
WHERE dest_airport &lt; 'Z'</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">In the <span style="font-style: italic;">Flights </span>table, most of the airport codes
begin with letters that are less than <span style="font-style: italic;">Z</span>. Depending
on the number of rows in the table, it is probably more efficient for <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to
go straight to the table to retrieve the appropriate rows. However, for the
following query, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> uses the index:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM Flights
WHERE dest_airport &lt; 'B'</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Only a few flights have airport codes that begin with a letter less than <span style="font-style: italic;">B</span>.</div></div></div><div><a name="N13277"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz856914"></a><div></div>Indexes have a cost for inserts, updates, and deletes</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> has to do work to maintain indexes. If you insert into or delete
from a table, the system has to insert or delete rows in all the indexes on
the table. If you update a table, the system has to maintain those indexes
that are on the columns being updated. So having a lot of indexes can speed
up select statements, but slow down inserts, updates, and deletes.  
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  Updates and deletes with WHERE clauses can use indexes for scans,
even if the indexed column is being updated.</div></div></div></div></div><div><a name="N13309"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunoptimz12168"></a><div></div>Joins and performance</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Joins, SQL statements in which <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> selects data from two
or more tables using one or more key columns from each table, can vary widely
in performance. Factors that affect the performance of joins are join order,
indexes, and join strategy.</div></div><div><a name="N1338E"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz857385"></a><div></div>Join order overview</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> optimizer usually makes a good
choice about join order. This section discusses the performance implications
of join order.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In a join operation involving two tables, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> scans the tables
in a particular order. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> accesses rows in one table first, and this
table is now called the <span style="font-style: italic;">outer table</span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Then, for each qualifying row in the outer table, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> looks for
matching rows in the second table, which is called the <span style="font-style: italic;">inner table</span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> accesses the outer table once, and the inner table probably
many times (depending on how many rows in the outer table qualify).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">This leads to a few general rules of thumb about join order:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>If the join has no restrictions in the WHERE clause that would limit the
number of rows returned from one of the tables to just a few, the following
rules apply:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>If <span style="font-style: italic;">only one</span> table has an index on the joined column
or columns, it is much better for that table to be the inner table. This is
because for each of the many inner table lookups, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can use an index
instead of scanning the entire table.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Since indexes on inner tables are accessed many times, if the index on
one table is smaller than the index on another, the table with the smaller
one should probably be the inner table. That is because smaller indexes (or
tables) can be cached (kept in <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>'s memory, allowing <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to
avoid expensive I/O for each iteration).</div></td></tr></table></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>On the other hand, if a query has restrictions in the WHERE clause for
one table that would cause it to return only a few rows from that table (for
example, WHERE flight_id = 'AA1111'), it is better for the restricted table
to be the outer table. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will have to go to the inner table only
a few times anyway.  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Consider:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM huge_table, small_table
WHERE huge_table.unique_column = 1
AND huge_table.other_column = small_table.non_unique_column</span></div></pre></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>In this case, the qualification <span style="font-style: italic;">huge_table.unique_column
= 1</span> (assuming a unique index on the column) qualifies only one row, so
it is better for <span style="font-style: italic;">huge_table</span> to be the outer table
in the join.</div></td></tr></table></div></div></div></div><div><a name="N13479"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz23173"></a><div></div>Join strategies</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The most common join strategy in <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is called a <span style="font-style: italic;">nested loop</span>. For each qualifying row in the outer table, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> uses
the appropriate access path (index or table) to find the matching rows in
the inner table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Another type of join in <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is called a <span style="font-style: italic;">hash</span> join. For joins of this type, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> constructs a hash table representing
all the selected columns of the inner table. For each qualifying row in the
outer table, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> does a quick lookup on the hash table to get the
inner table data. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> has to scan the inner table or index only once,
to build the hash table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Nested loop joins are preferable in most situations.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Hash joins are preferable in situations in which the inner table values
are unique and there are many qualifying rows in the outer table. Hash joins
require that the statement's WHERE clause be an optimizable equijoin:
 
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>It must use the = operator to compare column(s) in the outer table to
column(s) in the inner table.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>References to columns in the inner table must be simple column references.
Simple column references are described in <span style="color: blue;"><a href="#ctunoptimz24840">Directly optimizable predicates</a></span>.</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The hash table for a hash join is held in memory and if it gets big enough,
it will spill to the disk. The optimizer makes a very rough
estimate of the amount of memory required to make the hash table. If it estimates
that the amount of memory required would exceed the system-wide limit of memory
use for a table, the optimizer chooses a nested loop join instead. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">If memory use is not a problem for your environment, set this property
to a high number; allowing the optimizer the maximum flexibility in considering
a join strategy queries involving large queries leads to better performance.
It can also be set to smaller values for more limited environments.  
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> allows multiple columns as hash keys.</div></div></div></div></div><div><a name="N1355F"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunoptimz42425"></a><div></div>Derby's cost-based optimization</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The query optimizer makes cost-based decisions to determine:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Which index (if any) to use on each table in a query (see <span style="color: blue;"><a href="#ctunoptimz32184">About the optimizer's choice of access path</a></span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The join order (see <span style="color: blue;"><a href="#ctunoptimz20327">About the optimizer's choice of join order</a></span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The join strategy (see <span style="color: blue;"><a href="#ctunoptimz11941">About the optimizer's choice of join strategy</a></span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Whether to avoid additional sorting (see <span style="color: blue;"><a href="#ctunoptimz27036">About the optimizer's choice of sort avoidance</a></span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Automatic lock escalation (see <span style="color: blue;"><a href="#ctunoptimz19357">About the system's selection of lock granularity</a></span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Whether to use bulk fetch (see <span style="color: blue;"><a href="#ctunoptimz29384">About the optimizer's selection of bulk fetch</a></span>)</div></td></tr></table></div></div></div><div><a name="N13668"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz32184"></a><div></div>About the optimizer's choice of access path</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer's choice of access path can depend on the number of rows
it will have to read. It tries to choose a path that requires the fewest number
of rows read. For joins, the number of rows read also depends heavily on the
join order (discussed in <span style="color: blue;"><a href="#ctunoptimz20327">About the optimizer's choice of join order</a></span>.)</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">How does the optimizer know how many rows a particular access path will
read? The answer: sometimes it knows exactly, and sometimes it has to make
an educated guess. See <span style="color: blue;"><a href="#ctunstats18908">Selectivity and cardinality statistics</a></span>.</div></div></div><div><a name="N1370F"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz20327"></a><div></div>About the optimizer's choice of join order</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer chooses the optimal join order as well as the optimal index
for each table. The join order can affect which index is the best choice.
The optimizer can choose an index as the access path for a table if it is
the inner table, but not if it is the outer table (and there are no further
qualifications).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer chooses the join order of tables only in simple FROM clauses.
Most joins using the JOIN keyword are flattened into simple joins, so the
optimizer chooses their join order.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer does not choose the join order for outer joins; it uses the
order specified in the statement.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When selecting a join order, the optimizer takes into account:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The size of each table</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The indexes available on each table</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Whether an index on a table is useful in a particular join order</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The number of rows and pages to be scanned for each table in each join
order</div></td></tr></table></div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> does transitive closure on qualifications.
For details, see <span style="color: blue;"><a href="#ctuntransform37032">Transitive closure</a></span>.</div></div></div><div><a name="N137E2"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz32767"></a><div></div>Join order case study: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For example, consider the following situation:</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The <span style="font-style: italic;">Flights</span> table (as you know) stores information
about flight segments. It has a primary key on the <span style="font-style: italic;">flight_id</span> and <span style="font-style: italic;">segment_number </span>columns. This primary key
constraint is backed up by a unique index on those columns.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The <span style="font-style: italic;">FlightAvailability</span> table, which stores information
about the availability of flight segments on particular days, can store several
rows for a particular row in the <span style="font-style: italic;">Flights</span> table (one
for each date).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">You want to see information about all the flights, and you issue the following
query:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM FlightAvailability AS fa, Flights AS fts
WHERE fa.flight_id = fts.flight_id
AND fa.segment_number = fts.segment_number</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">First imagine the situation in which there are no useful indexes on the <span style="font-style: italic;">FlightAvailability</span> table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Using the join order with <span style="font-style: italic;">FlightAvailability</span> as
the outer table and <span style="font-style: italic;">Flights</span> as the inner table is
cheaper because it allows the <span style="font-style: italic;">flight_id</span>/<span style="font-style: italic;">segment_number</span> columns from <span style="font-style: italic;">FlightAvailability</span> to
be used to probe into and find matching rows in <span style="font-style: italic;">Flights,</span> using the primary key index on <span style="font-style: italic;">Flights.flight_id</span> and <span style="font-style: italic;">Flights.segment_number</span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This is preferable to the opposite join order (with <span style="font-style: italic;">Flights</span> as the outer table and <span style="font-style: italic;">FlightAvailability</span> as the inner table) because in that case, for each row in <span style="font-style: italic;">Flights,</span> the system would have to scan the entire <span style="font-style: italic;">FlightAvailability</span> table to find the matching rows (because there is
no useful index- an index on the <span style="font-style: italic;">flight_id</span>/<span style="font-style: italic;">segment_number</span> columns).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Second, imagine the situation in which there is a useful index on the <span style="font-style: italic;">FlightAvailability</span> table (this is actually the case in
the sample database). <span style="font-style: italic;">FlightAvailability</span> has a primary
key index on <span style="font-style: italic;">flight_id</span>, <span style="font-style: italic;">segment_number</span>, and <span style="font-style: italic;">booking_date</span>. In that index, the <span style="font-style: italic;">flight_id</span>-<span style="font-style: italic;">segment_number</span> combination is not unique,
since there is a one-to-many correspondence between the <span style="font-style: italic;">Flights</span> table and the <span style="font-style: italic;">FlightAvailability</span> table.
However, the index is still very useful for finding rows with particular <span style="font-style: italic;">flight_id</span>/<span style="font-style: italic;">segment_number</span> values.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">You issue the same query:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM FlightAvailability AS fa, Flights AS fts
WHERE fa.flight_id = fts.flight_id
AND fa.segment_number = fts.segment_number</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Although the difference in cost is smaller, it is still cheaper for the <span style="font-style: italic;">Flights</span> table to be the inner table, because its index
is unique, whereas <span style="font-style: italic;">FlightAvailability</span>'s index
is not. That is because it is cheaper for <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to step through a unique
index than through a non-unique index.</div></div></div></div><div><a name="N1391F"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz11941"></a><div></div>About the optimizer's choice of join strategy</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer compares the cost of choosing a hash join (if a hash join
is possible) to the cost of choosing a nested loop join and chooses the cheaper
strategy. For information about when hash joins are possible, see <span style="color: blue;"><a href="#ctunoptimz23173">Join strategies</a></span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In some cases, the size of the hash table that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> would have to
build is prohibitive and can cause the JVM to run out of memory. For this
reason, the optimizer has an upper limit on the size of a table on which it
will consider a hash join. It will not consider a hash join for a statement
if it estimates that the size of the hash table would exceed the system-wide
limit of memory use for a table, the optimizer chooses a nested loop join
instead. The optimizer's estimates of size of hash tables are approximate
only.  </div></div></div><div><a name="N139BA"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz27036"></a><div></div>About the optimizer's choice of sort avoidance</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Some SQL statements require that data be ordered, including those with
ORDER BY, GROUP BY, and DISTINCT. MIN() and MAX() aggregates also require
ordering of data.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can sometimes avoid sorting steps for:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>statements with ORDER BY  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">See <span style="color: blue;"><a href="#ctunoptimz56859">Cost-based ORDER BY sort avoidance</a></span></div></div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can also perform the following optimizations, but they are
not based on cost:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>sort avoidance for DISTINCT and GROUP BYs  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">See <span style="color: blue;"><a href="#ctunoptimz22460">Non-cost-based sort avoidance (tuple filtering)</a></span></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>statements with a MIN() aggregate  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">See <span style="color: blue;"><a href="#ctunoptimz22111">The MIN() and MAX() optimizations</a></span></div></div></td></tr></table></div></div></div><div><a name="N13A9E"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz56859"></a><div></div>Cost-based ORDER BY sort avoidance: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Usually, sorting requires an extra step to put the data into the right
order. This extra step can be avoided for data that are already in the right
order. For example, if a single-table query has an ORDER BY on a single column,
and there is an index on that column, sorting can be avoided if <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> uses
the index as the access path.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Where possible, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>'s query compiler transforms an SQL statement
internally into one that avoids this extra step. For information about internal
transformations, see <span style="color: blue;"><a href="#ctuntransform16033">Sort avoidance</a></span>. This
transformation, if it occurs, happens before optimization. After any such
transformations are made, the optimizer can do its part to help avoid a separate
sorting step by choosing an already sorted access path. It compares the cost
of using that path with the cost of sorting. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> does this for statements
that use an ORDER BY clause in the following situations:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The statements involve tables with indexes that are in the correct order.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The statements involve scans of unique indexes that are guaranteed to
return only one row per scan.</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">ORDER BY specifies a priority of ordering of columns in a result set. For
example, ORDER BY X, Y means that column <span style="font-style: italic;">X</span> has a more
significant ordering than column <span style="font-style: italic;">Y</span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The situations that allow <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to avoid a separate
ordering step for statements with ORDER BY clauses are:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Index scans, which provide the correct order.  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- covering index</span>
SELECT flight_id FROM Flights ORDER BY flight_id</span></div></pre></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The rows from a table when fetched through an index scan.  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- if <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>  uses the index on orig_airport
-- to access the data, it can avoid the sort
-- required by the final ORDER BY</span>
SELECT orig_airport, miles
FROM FLIGHTS
WHERE orig_airport &lt; 'DDD'
ORDER BY orig_airport</span></div></pre></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The rows from a join when ordered by the indexed column or columns in
the outer table.  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- if <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>  chooses Cities as the outer table, it
-- can avoid a separate sorting step</span></span>
SELECT * FROM cities, countries
WHERE cities.country_ISO_code = countries.country_ISO_code
AND cities.country_ISO_code &lt; 'DD'
ORDER BY cities.country_ISO_code</span></div></pre></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Result sets that are guaranteed to return a single row. They are ordered
on <span style="font-style: italic;">all</span> of their columns (for example, if there are
equality conditions on all the columns in a unique index, all the columns
returned for that table can be considered ordered, with any priority of ordering
of the columns).  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- query will only return one row, so that row is
-- "in order" for ANY column</span>
SELECT miles
FROM Flights
WHERE flight_id = 'US1381' AND segment_number = 2
ORDER BY miles</span></div></pre></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Any column in a result set that has an equality comparison with a constant.
The column is considered ordered with no priority to its ordering.   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- The comparison of segment_number
-- to a constant means that it is always correctly
-- ordered. Using the index on (flight_id, segment_number)
-- as the access path means
-- that the ordering will be correct for the ORDER BY
-- clause in this query. The same thing would be true if
-- flight_id were compared to a constant instead.</span>
SELECT segment_number, flight_id
FROM Flights
WHERE segment_number=2
ORDER BY segment_number, flight_id</span></div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">And because of transitive
closure, this means that even more complex statements can avoid sorting. For
example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- transitive closure means that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>  will
-- add this clause:
-- AND countries.country_ISO_code = 'CL', which means
-- that the ordering column is now compared to a constant,
-- and sorting can be avoided.</span>
SELECT * FROM cities, countries
WHERE cities.country_ISO_code = 'CL'
AND cities.country_ISO_code = countries.country_ISO_code
ORDER BY countries.country_ISO_code</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For more information
about transitive closure and other statement transformations, see <span style="color: blue;"><a href="#ctuntransform13966">Internal language transformations</a></span>.</div></div></td></tr></table></div></div></div></div></div><div><a name="N13BCE"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz19357"></a><div></div>About the system's selection of lock granularity</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When a system is configured for row-level locking, it decides whether to
use table-level locking or row-level locking for each table in each DML statement.
The system bases this decision on the number of rows read or written for each
table, and on whether a full conglomerate scan is done for each table.   
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  When you have turned off row-level locking for your system, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> always
uses table-level locking.</div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The first goal of the system's decision is concurrency; wherever possible,
the system chooses row-level locking. However, row-level locking uses a lot
of resources and might have a negative impact on performance. Sometimes row-level
locking does not provide much more concurrency than table-level locking. In
those situations, the system might choose to escalate the locking scheme from
row-level locking to table-level locking to improve performance. For example,
if a connection is configured for TRANSACTION_SERIALIZABLE isolation, the
system chooses table-level locking for the following statement:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM FlightAvailability AS fa, Flights AS fts
WHERE fts.flight_id = fa.flight_id
AND fts.segment_number = fa.segment_number</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">To satisfy the isolation requirements, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> would have to lock all
the rows in both the<span style="font-style: italic;"> FlightAvailability</span> and the <span style="font-style: italic;">Flights</span> tables. Locking both the tables would be cheaper,
would provide the same isolation, and would allow the same concurrency.  
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  You can force lock escalation for specific tables when you alter
them with the LOCKSIZE clause. For these tables, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> always chooses
table-level locking. For more information, see the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span></span>.</div></div></div><div><a name="N13CD5"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz1008884"></a><div></div>How the system makes its decision if it has a choice: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">If the lock granularity (whether to lock rows or entire tables) is not
forced by the user, the system makes a decision using the following rules:
 
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For SELECT statements running in READ_COMMITTED isolation, the system
always chooses row-level locking.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>If the statement scans the entire table or index and it does not meet
the criteria above, the system chooses table-level locking. (A statement scans
the entire table whenever it chooses a table as the access path.)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>If a statement partially scans the index, the system uses row-level locking,
until the number of rows touched on a table reaches lock escalation threshold.
It is then escalated to a table lock. (You can configure this threshold number;
see <span style="color: blue;"><a href="#ctunoptimz26019">Lock escalation threshold</a></span>.)  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For SELECT, UPDATE, and DELETE statements, the number of rows touched
is different from the number of rows read. If the same row is read more than
once, it is considered to have been touched only once. Each row in the inner
table of a join can be read many times, but can be touched at most one time.</div></td></tr></table></div></div></td></tr></table></div></div></div></div><div><a name="N13D37"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz26019"></a><div></div>Lock escalation threshold: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The system property <span style="font-style: italic;">derby.locks.escalationThreshold</span> determines
the threshold for number of rows touched for a particular table above which
the system will escalate to table-level locking. The default value of this
property is 5000. For large systems, set this property to a higher value.
For smaller systems, lower it. See the
"<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> properties" section of
the <span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span> for details on this property.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">This property also sets the threshold for transaction-based lock escalation
(see <span style="color: blue;"><a href="#ctunoptimz42065">Transaction-based lock escalation</a></span>).  
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  For more
information about lock escalation, see <span style="color: blue;"><a href="#ctunoptimz27975">Locking and performance</a></span>.</div></div></div></div></div><div><a name="N13DBC"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz29384"></a><div></div>About the optimizer's selection of bulk fetch</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">When <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> retrieves data from a conglomerate, it can fetch more
than one row at a time. Fetching more than one row at a time is called bulk
fetch. By default, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> fetches 16 rows at a time.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Bulk fetch is faster than retrieving one row at a time when a large number
of rows qualify for each scan of the table or index. Bulk fetch uses extra
memory to hold the pre-fetched rows, so it should be avoided in situations
in which memory is scarce.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Bulk fetch is automatically turned off for updatable cursors, for hash
joins, for statements in which the scan returns a single row, and for subqueries.
It is useful, however, for table scans or index range scans:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM Flights
WHERE miles &gt; 4

SELECT *
FROM Flights</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The default size for bulk fetch (16 rows) typically provides good performance.</div></div></div></div></div><div><a name="N13E69"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunoptimz27975"></a><div></div>Locking and performance</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Row-level locking improves concurrency in a multi-user system. However,
a large number of row locks can degrade performance. <span style="color: blue;"><a href="#ctunoptimz19357">About the system's selection of lock granularity</a></span> discussed the way the optimizer makes some compile-time decisions
about escalating row locks to table locks for performance reasons. This section
discusses ways in which the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> system and the user can make similar
lock escalations.  
</div></div><div><a name="N13F04"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunoptimz42065"></a><div></div>Transaction-based lock escalation</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer makes its decisions for the scope of a single statement at
compile time; the runtime overrides are also for the scope of a single statement.
As you know, a transaction can span several statements. For connections running
in TRANSACTION_SERIALIZABLE isolation and for connections that are doing a
lot of inserts or updates, a transaction can accumulate a number of row locks
even though no single statement would touch enough rows to make the optimizer
choose table-level locking for any single table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">However, during a transaction, the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> system tracks the number
of locks for all tables in the transaction, and when this number exceeds a
threshold number (which you can configure; see <span style="color: blue;"><a href="#ctunoptimz26019">Lock escalation threshold</a></span>), the system attempts to escalate locking for at least one
of the tables involved from row-level to table-level locking.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The system attempts to escalate to table-level locking for each table that
has a burdensome number of locks by trying to obtain the relevant table lock.
If the system can lock the table without waiting, the system locks the entire
table and releases all row locks for the table. If the system cannot lock
the table without waiting, the system leaves the row locks intact.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">After a table is locked in either mode, a transaction does not acquire
any subsequent row-level locks on a table. For example, if you have a table
called <span style="font-style: italic;">Hotels</span> that contained several thousand rows
and a transaction locks the entire table in share mode in order to read data,
it might later need to lock a particular row in exclusive mode in order to
update the row. However, the previous table-level lock on <span style="font-style: italic;">Hotels</span> forces the exclusive lock to be table-level as well.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This transaction-based runtime decision is independent of any compilation
decision. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If when the escalation threshold was exceeded the system did not obtain
any table locks because it would have had to wait, the next lock escalation
attempt is delayed until the number of held locks has increased by some significant
amount, for example from 5000 to 6000.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Here are some examples assuming the escalation threshold is 5000:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Single table holding the majority of the locks  
<div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><thead><tr><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Table</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Number of row locks</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Promote?</div></td></tr></thead><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">Hotels</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>4853</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>yes</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">Countries</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>3</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">Cities</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>12</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr></tbody></table></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Two tables holding the majority of the locks  
<div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><thead><tr><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Table</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Number of row locks</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Promote?</div></td></tr></thead><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">Hotels</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>2349</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>yes</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">Countries</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>3 </div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">Cities</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>1800</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>yes</div></td></tr></tbody></table></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Many tables holding a small number of locks  
<div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><thead><tr><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Table</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Number of row locks</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Promote?</div></td></tr></thead><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">table001</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>279</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">table002</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>142</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">table003</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>356</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">table004</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>79</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">table194</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>384</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-style: italic;">table195</span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>416</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>no</div></td></tr></tbody></table></div></div></td></tr></table></div></div></div></div><div><a name="N14197"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunoptimz11775"></a><div></div>Locking a table for the duration of a transaction</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In addition, you can explicitly lock a table for the duration of a transaction
with the LOCK TABLE statement. This is useful if you know in advance that
an entire table should be locked and want to save the resources required for
obtaining row locks until the system escalates the locking. For information
about this feature, see "LOCK TABLE statement" in the <span style="font-style: italic;"><span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span></span>.</div></div></div></div><div><a name="N141FA"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunoptimz860097"></a><div></div>Non-cost-based optimizations</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer makes some non-cost-based optimizations, which means that
it does not consider them when determining the access path and join order.
If all the conditions are right, it makes the optimizations after the access
path and join order are determined.  
</div></div><div><a name="N14275"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunoptimz22460"></a><div></div>Non-cost-based sort avoidance (tuple filtering)</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In most cases, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> needs to perform two separate steps for statements
that use DISTINCT or GROUP BY: first sorting the selected columns, then either
discarding duplicate rows or aggregating grouped rows. Sometimes it is able
to avoid sorting for these statements with tuple filtering. <span style="font-style: italic;">Tuple filtering</span> means that the rows are <span style="font-style: italic;">already</span> in
a useful order. For DISTINCT, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can simply filter out duplicate
values when they are found and return results to the user sooner. For GROUP
BY, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can aggregate a group of rows until a new set of rows is detected
and return results to the user sooner.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">These are non-cost-based optimizations; the optimizer does not yet consider
the cost of these optimizations.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The examples in this section refer to the following tables:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">CREATE TABLE t1(c1 INT, c2 INT, c3 INT, c4 INT)
CREATE INDEX i1 ON t1(c1)
CREATE INDEX i1_2_3_4 ON t1(c1, c2, c3, c4)</span></div></pre></div></div><div><a name="N14306"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz859947"></a><div></div>DISTINCT</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Tuple filtering is applied for a DISTINCT when the following criteria are
met:   
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The SELECT list is composed entirely of simple column references and constants. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>All simple column references come from the same table and the optimizer
has chosen the table in question to be the outermost table in the query block. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The optimizer has chosen an index as the access path for the table in
question. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The simple column references in the SELECT list, plus any simple column
references from the table that have equality predicates on them, are a prefix
of the index that the optimizer selected as the access path for the table. </div></td></tr></table></div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  The set of column references must be an in-order prefix
of the index.</div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Here is the most common case in which tuple filtering will be applied:
  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT DISTINCT c1 FROM t1</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Equality predicates allow tuple filtering on the following:   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT DISTINCT c2
FROM t1
WHERE c1 = 5

SELECT DISTINCT c2, c4
FROM t1
WHERE c1 = 5 and c3 = 7
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- the columns don't have to be in the
-- same order as the index</span>
SELECT DISTINCT c2, c1
FROM t1</span></div></pre></div></div><div><a name="N14398"></a><div style="font-size: 11pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz1011736"></a><div></div>Quick DISTINCT scans: </div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can use a hash table instead of a sorter to eliminate duplicates
when performing a DISTINCT in the following cases:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>There is a single table in the query block. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>An ORDER BY clause is not merged into the DISTINCT. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>All entries in the SELECT list are simple column references. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>There are no predicates in the query block. </div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">This technique allows for minimal locking when performing the scan at the
READ COMMITTED isolation level.   
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  This technique appears in
RunTimeStatistics as a <span style="font-style: italic;">DistinctScanResultSe</span>t.</div></div></div></div></div><div><a name="N143F5"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="ctunoptimz859974"></a><div></div>GROUP BY</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Tuple filtering is applied for a GROUP BY when the following criteria are
met:   
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>All grouping columns come from the same table and the optimizer has chosen
the table in question to be the outermost table in the query block. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The optimizer has chosen an index as the access path for the table in
question. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The grouping columns, plus any simple column references from the table
that have equality predicates on them, are a prefix of the index that the
optimizer selected as the access path for the table. </div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Here is the most common case in which tuple filtering will be applied:
  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT max(c2) FROM t1 GROUP BY c1</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Equality predicates allow tuple filtering on the following:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT c2, SUM(c3)
FROM t1
WHERE c1 = 5 GROUP BY c2

SELECT max(c4)
FROM t1
WHERE c1 = 5 AND c3 = 6 GROUP BY c2</span></div></pre></div></div></div></div><div><a name="N14464"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunoptimz22111"></a><div></div>The MIN() and MAX() optimizations</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer knows that it can avoid iterating through all the source
rows in a result to compute a MIN() or MAX() aggregate when data are already
in the right order. When data are guaranteed to be in the right order, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can
go immediately to the smallest (minimum) or largest (maximum) row.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following conditions must be true:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The MIN() or MAX() is the only entry in the SELECT list.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The MIN() or MAX() is on a simple column reference, not on an expression.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For MAX(), there must not be a WHERE clause.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For MIN():  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The referenced table is the outermost table in the optimizer's chosen
join order for the query block.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The optimizer chose an index containing the referenced column as the access
path.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The referenced column is the first key column in that index OR the referenced
column is a key column in that index and equality predicates exist on all
key columns prior to the simple column reference in that index.</div></td></tr></table></div></div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, the optimizer can use this optimization for the following
queries (if the optimizer uses the appropriate indexes as the access paths):
 
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- index on orig_airport</span>
SELECT MIN(orig_airport)
FROM Flights
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- index on orig_airport</span>
SELECT MAX(orig_airport)
FROM Flights
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- index on orig_airport</span>
SELECT miles 
FROM Flights 
WHERE orig_airport = (SELECT MIN(orig_airport)
FROM Flights)
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- index on segment_number, flight_id</span>
SELECT MIN(segment_number) 
FROM Flights 
WHERE flight_id = 'AA1111' 
SELECT * 
FROM Flights 
WHERE segment_number = (SELECT MIN(segment_number) 
FROM Flights 
WHERE flight_id = 'AA1111')</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer decides whether to implement the optimization after choosing
the plan for the query. The optimizer does not take this optimization into
account when costing the plan.</div></div></div></div><div><a name="N14515"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunoptimzoverride"></a><div></div>Overriding the default optimizer behavior</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">You can override the default behavior of the Derby query optimizer by including
a --DERBY-PROPERTIES clause and an associated property as a comment within
an SQL statement.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Because optimizer overrides are expressed as comments, they must be included
at the end of a line.  You can specify optimizer override properties for an
entire FROM clause, for tables in the FROM clause, or for both. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The syntax for a FROM clause property is:<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">FROM [ -- DERBY-PROPERTIES <span style="color: blue;"><a href="#joinorder">joinOrder</a></span> = { FIXED | UNFIXED } ]
     <span style="font-style: italic;">TableExpression</span> [,<span style="font-style: italic;">TableExpression</span>]*</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The syntax for table optimizer override properties, which must be included
at the end of a TableExpression, is:<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">{<span style="font-style: italic;">table-Name</span> | <span style="font-style: italic;">view-Name</span> }
     [ [ AS ] <span style="font-style: italic;">correlation-Name</span>
     [ (<span style="font-style: italic;">Simple-column-Name</span> [ , <span style="font-style: italic;">Simple-column-Name</span> ]* ) ] ]
     [ -- DERBY-PROPERTIES { <span style="color: blue;"><a href="#constraint">constraint</a></span> = <span style="font-style: italic;">constraint-Name</span> | <span style="color: blue;"><a href="#index">index</a></span> = <span style="font-style: italic;">index-Name</span> | <span style="color: blue;"><a href="#joinstrat">joinStrategy</a></span> = { NESTEDLOOP | HASH } } ]</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The space between -- and DERBY-PROPERTIES is optional.</div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">&gt;
        Important: </span>  Make sure that you adhere to the correct syntax when
using the --DERBY-PROPERTIES clause.  Failure to do so can cause the parser
to interpret it as a comment and ignore it. To verify that the parser interpreted
your overrides correctly, you can use RunTimeStatistics. See <span style="color: blue;"><a href="#ctundepthoptover">Optimizer
overrides</a></span> for more information.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following four properties are available for use in a --DERBY-PROPERTIES
clause:<div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">constraint</span></div><div style="margin-left: 72pt + 16pt;">To force the use of the index that enforces a primary key, a foreign key,
or unique constraint, use the constraint property and specify the  unqualified
name of the constraint. The constraint property can be used only within a
TableExpression, and it  can be specified only on base tables; it cannot be
specified on views or derived tables.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">index</span></div><div style="margin-left: 72pt + 16pt;">The index property is similar to the constraint property. To force use
of a particular index, specify the unqualified index name. To force a table
scan, specify null for the index name. The index property can be used only
within a TableExpression, and it can be specified only on base tables; it
cannot be specified on views or derived tables.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">joinOrder</span></div><div style="margin-left: 72pt + 16pt;">Use the joinOrder property to override the optimizer&rsquo;s choice of join
order for two tables. When the value FIXED is specified, the optimizer will
choose the order of tables as they appear in the FROM clause as the join order.
 Valid values for the joinOrder property include FIXED and UNFIXED. The joinOrder
property can be used with a FROM clause.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">joinStrategy</span></div><div style="margin-left: 72pt + 16pt;">Use the joinStrategy property to override the optimizer&rsquo;s choice of join
strategy. The two types of join strategy are called <span style="font-style: italic;">nested loop</span> and <span style="font-style: italic;">hash</span>.
In a nested loop join strategy, for each qualifying row in the outer table,
Derby uses the appropriate access path (index or table scan) to find the matching
rows in the inner table. In a hash join strategy, Derby constructs a hash
table that represents the inner table. For each qualifying row in the outer
table, Derby does a quick lookup on the hash table to find the matching rows
in the inner table. Derby needs to scan the inner table or index only once
to create the hash table. The --DERBY-PROPERTIES parameter must immediately
follow the inner table.  <div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Typically, you will use the joinStrategy property
only in conjunction with the joinOrder property. Specifying a join strategy
without knowing the join order can result in less-than-optimal performance.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Valid
values include HASH and NESTEDLOOP. The joinStrategy property can be used
only within a TableExpression.</div></div></div></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following examples illustrate the use of the --DERBY-PROPERTIES clause:<div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">constraint</span></div><div style="margin-left: 72pt + 16pt;"><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">CREATE TABLE t1 (c1 int, c2 int, c3 int, CONSTRAINT cons1 PRIMARY KEY (c1, c2))
INSERT INTO t1 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3), (4, 4, 4)
SELECT * FROM t1 --DERBY-PROPERTIES constraint=cons1
FOR UPDATE</span></div></pre></div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">index</span></div><div style="margin-left: 72pt + 16pt;"><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">CREATE TABLE t1 (c1 int, c2 int, c3 int, CONSTRAINT cons1 PRIMARY KEY (c1, c2))
INSERT INTO t1 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3), (4, 4, 4)
CREATE INDEX t1_c1 ON t1(c1)
SELECT * FROM t1 --DERBY-PROPERTIES index=t1_c1
WHERE c1=1</span></div></pre></div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">joinOrder</span></div><div style="margin-left: 72pt + 16pt;"><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">CREATE TABLE t1 (c1 int, c2 int, c3 int, CONSTRAINT cons1 PRIMARY KEY (c1, c2))
CREATE TABLE t2 (c1 int not null, c2 int not null, c3 int, CONSTRAINT cons2 UNIQUE (c1, c2))
INSERT INTO t1 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3), (4, 4, 4)
INSERT INTO t2 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3), (4, 4, 4)
SELECT * FROM --DERBY-PROPERTIES joinOrder=FIXED
t1, t2
WHERE t1.c1=t2.c1</span></div></pre></div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">joinStrategy</span></div><div style="margin-left: 72pt + 16pt;"><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">CREATE TABLE t1 (c1 int, c2 int, c3 int, CONSTRAINT cons1 PRIMARY KEY (c1, c2))
CREATE TABLE t2 (c1 int not null, c2 int not null, c3 int, CONSTRAINT cons2 UNIQUE (c1, c2))
INSERT INTO t1 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3), (4, 4, 4)
INSERT INTO t2 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3), (4, 4, 4)
SELECT * FROM --DERBY-PROPERTIES joinOrder=FIXED 
t1 a, t1 b --DERBY-PROPERTIES joinStrategy=NESTEDLOOP
WHERE a.c1=b.c1</span></div></pre></div></div></div></div></div></div></div><div><a name="N146B2"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="ctunstats18908"></a><div></div>Selectivity and cardinality statistics</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The optimizer determines the number of rows that will be scanned from disk
when deciding on an access path for a particular table (whether to use an
index or to scan the table).
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The optimizer knows "exactly" the number of rows that will be
scanned from disk for table scans (see <span style="color: blue;"><a href="#ctunstats57793">Determinations of rows scanned from disk for a table scan</a></span>).</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>For index scans, the optimizer must estimate the number of rows that will
be scanned from disk. (see <span style="color: blue;"><a href="#ctunstats60669">Estimations of rows scanned from disk for an index scan</a></span>). <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> might
be able to use cardinality statistics to make a better estimate of the number
of rows that will be scanned from disk as described in this chapter.</div></td></tr></table></div></div></div><div><a name="N14755"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunstats57793"></a><div></div>Determinations of rows scanned from disk for a table scan</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For table scans, the optimizer does not need to estimate the number of
rows that will be scanned from disk during the scan; the number of rows that
will be scanned from disk will be equal to the number of rows in the table,
as described below.</div></div><div><a name="N147E7"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunstats848901"></a><div></div>How the optimizer determines the number of rows in a table</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The optimizer uses a stored row count to determine the number of rows in
a table, which is maintained automatically by the system. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Normally, an updated value is stored in the database whenever the database
goes through an orderly shutdown (as long as the database is not read-only).
Stored row counts become inaccurate if there is a non-orderly shutdown (for
example, a power failure or other type of system crash).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">You can correct the optimizer's row count without shutting down the
system; <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> sets the stored row count for a table to the correct value
whenever a query that does a full scan on the base conglomerate finishes.
For example, executing the following query sets the row count for table <span style="font-style: italic;">Flights</span> to the correct value:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">
SELECT * FROM Flights</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> also sets the stored row count on a table to the correct value
whenever a user creates a new index or primary key, unique, or foreign key
constraint on the table. This value is not guaranteed to be written to disk.</div></div></div></div><div><a name="N14841"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunstats60669"></a><div></div>Estimations of rows scanned from disk for an index scan</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">When an index is available, the optimizer has to estimate the number of
rows that will be scanned from disk. The accuracy of this estimate depends
on the type of query being optimized.</div></div><div><a name="N148CA"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunstats848961"></a><div></div>Queries with a known search condition</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">When the exact start and stop conditions are known at compilation time,
the optimizer uses the index itself to make a very precise estimate of the
number of rows that will be scanned from disk. An example of a query with
a known search condition:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT *
FROM Flights
WHERE orig_airport = 'SFO'</span></div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The search value, 'SFO', is known. The optimizer will be able to make an
accurate estimate of the cost of using the index <span style="font-style: italic;">orig_index</span>. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">In addition, if the index is unique, and the WHERE clause involves an =
or IS NULL comparison to all the columns in the index, the optimizer knows
that only a single row will be scanned from disk. For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="font-weight: bold;">-- there's a unique key on city_id</span>
SELECT * FROM Cities WHERE city_id = 1</span></div></pre></div></div></div><div><a name="N14943"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunstats849000"></a><div></div>Queries with an unknown search condition</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Queries sometimes have an unknown search condition, such as in the case
when the statement's WHERE clause involves dynamic parameters that are
known only at execution time and not at compilation time, or when the statement
involves a join. For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="border-right-width: 0pt; border-left-width: 0pt;">-- dynamic parameters</span>
SELECT *
FROM Flights
WHERE orig_airport = ?

rollback
<span style="border-right-width: 0pt; border-left-width: 0pt;">-- joins</span>
SELECT * FROM Countries, Cities
WHERE Countries.country_ISO_code = Cities.country_ISO_code
<span style="border-right-width: 0pt; border-left-width: 0pt;">
-- complex search conditions</span>
SELECT * FROM Countries
WHERE region = (select region from Countries where country = 'Spain')</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In the above SELECT statements, the optimizer cannot get enough useful
information from the index about how many rows will be returned by a particular
access path. However, it can often make a good guess by looking at a table's <span style="font-style: italic;">selectivity</span> for a particular WHERE clause.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Selectivity refers to the fraction of rows that will be returned from the
table for the particular WHERE clause. The optimizer multiplies the number
of rows in the table by the <span style="font-style: italic;">selectivity</span> for a particular
operation. For example, if the selectivity for a particular search operation
is .10, and the table contains 100 rows, the optimizer estimates that the
operation will return 10 rows. (This is not exact; it is just a good guess.)
 </div></div></div></div><div><a name="N149C4"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunstats849203"></a><div></div>Statistics-based versus hard-wired selectivity</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> determines the selectivity for a WHERE clause in one of two
ways.</div></div><div><a name="N14A64"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunstats72938"></a><div></div>Selectivity from cardinality statistics</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Cardinality statistics are computed by the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> system and stored
in the system tables. For information on when these statistics get created
or updated, see <span style="color: blue;"><a href="#ctunstats57373">When cardinality statistics are automatically updated</a></span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can use cardinality statistics if:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The statistics exist</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The relevant columns in the WHERE column are leading columns in an index</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The columns are compared to values using only the = operator</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Statistics are not turned off in the system or query</div></td></tr></table></div></div></div></div><div><a name="N14AE4"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunstats52657"></a><div></div>Selectivity from hard-wired assumptions</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In all other cases, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> uses a fixed number that attempts to describe
the percentage of rows that will probably be returned; it might not correspond
to the actual selectivity of the operation in every case. It is an assumption
hard-wired into the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> system. These assumptions are shown in <span style="color: blue;"><a href="#rtunstats405">Selectivity for various operations for index scans when search values are unknown in advance and statistics are not used</a></span>.</div><div><div style="font-weight: bold;"><span style="color: red;">Table 2. </span>Selectivity for various operations for index scans
when search values are unknown in advance and statistics are not used</div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><thead><tr><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Operator</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Selectivity</div></td></tr></thead><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>=, &gt;=, &gt;, &lt;=, &lt;, &lt;&gt; when data type of
parameter is a boolean</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.5 (50%)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>other operators (except for IS NULL and IS NOT NULL) when
data type of parameter is boolean</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.5 (50%)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>IS NULL</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.1 (10%)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>IS NOT NULL</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.9 (90%)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>=</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.1 (10%)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>&gt;, &gt;=, &lt;, &lt;=</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.33 (3%)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>&lt;&gt; compared to non-boolean type</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.9 (90%)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>LIKE transformed from LIKE predicate (see <span style="color: blue;"><a href="#rtuntransform208">LIKE transformations</a></span>)</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>1.0 (100%)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>&gt;= and &lt; when transformed internally from LIKE (see <span style="color: blue;"><a href="#rtuntransform208">LIKE transformations</a></span>)</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.25 (.5 X .5)</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>&gt;= and &lt;= operators when transformed internally from
BETWEEN (see <span style="color: blue;"><a href="#rtuntransform139">BETWEEN transformations</a></span>)</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>.25 (.5 X .5)</div></td></tr></tbody></table></div></div></div></div><div><a name="N14C38"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunstats849251"></a><div></div>What are cardinality statistics?</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> creates statistics for a table's index, it calculates
and stores in the system tables:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The number of rows in the table</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The number of unique values for a set of columns for leading columns in
an index key, also known as <span style="font-style: italic;">cardinality</span>. Leading columns
refers to the first column, or the first and second column, or the first,
second, and third column of an index (and so on). <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> cannot compute
the number of columns for which a combination of the non-leading columns is
unique. </div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, consider the primary key on the table FlightAvailability:
 
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">CONSTRAINT FLIGHTAVAILABILITY_PK Primary Key (
      FLIGHT_ID,
      SEGMENT_NUMBER,
      FLIGHT_DATE)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For this index, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> keeps the following information:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The number of rows in the table <span style="font-style: italic;">FlightAvailability</span></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The number of unique rows for the full key (<span style="font-style: italic;">flight_id</span>, <span style="font-style: italic;">segment_number</span>, <span style="font-style: italic;">flight_date</span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The number of unique rows for the key (<span style="font-style: italic;">flight_id</span>, <span style="font-style: italic;">segment_number</span>)</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The number of unique rows for the key (<span style="font-style: italic;">flight_id</span>)</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">How does <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> use these two numbers-the number of rows in
a table and the cardinality of a particular key-to determine the selectivity
of a query? Take this example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights, FlightAvailability
WHERE Flights.flight_id = OtherTable.flight_id</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">If the cardinality for flight_id in <span style="font-style: italic;">Flights</span> is
250, then the selectivity of the predicate is 1/250. The optimizer would estimate
the number of rows read to be:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">((Rows in Flights) * (Rows in OtherTable))/250</span></div></pre></div></div></div><div><a name="N14D57"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctunstats46438"></a><div></div>Working with cardinality statistics</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Cardinality Statistics are gathered on the keys of an index when the index
is created.</div></div><div><a name="N14DF2"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunstats57373"></a><div></div>When cardinality statistics are automatically updated</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For the following operations that you perform on a table, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> automatically
creates new statistics or updates existing statistics:   <div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>When you create a new index on an existing non-empty table. Statistics
are automatically created for only the new index.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>When you add a primary key, unique, or foreign key constraint to an existing
non-empty table. If there is no existing index that can be used for the new
key or constraint, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> automatically
creates statistics for only the new indexes.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>When you run the SYSCS_UTIL.SYSCS_COMPRESS_TABLE system procedure. Statistics
are created automatically for all indexes if the statistics do not already
exist.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>When you drop a column that is part of a table's index, the statistics
for the affected index are dropped. Statistics are automatically updated for
the other indexes on the table.</div></td></tr></table></div></div></div></div><div><a name="N14E70"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctunstats849505"></a><div></div>When cardinality statistics go stale</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">As you saw in <span style="color: blue;"><a href="#ctunstats57373">When cardinality statistics are automatically updated</a></span>, cardinality
statistics are automatically updated only in limited cases. Normal insert,
update, and delete statements do not cause the statistics to be updated. This
means that statistics can go stale. Stale statistics can slow your system
down, because they worsen the accuracy of the optimizer's estimates of
selectivity.  </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
    Most of the statistics information that 
    <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>
    uses is automatically kept up
    to date as part of underlying index and table maintenance.
    This information includes the count of rows in the table and
    the distribution of data in indexes.
</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">
    The one piece of information that is not kept up to date is the
    average number of duplicates for columns in an index.
This statistic is given a default and
then is updated whenever you create an index or update the statistics by
running either the <span style="font-family: Courier;">SYSCS_UTIL.SYSCS_UPDATE_STATISTICS</span> or the
<span style="font-family: Courier;">SYSCS_UTIL.SYSCS_COMPRESS_TABLE</span> built-in system procedure.
</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Statistics are likely to be stale if the number of distinct values in an
index has changed significantly. This can happen often or rarely, depending on
the nature of the column being indexed. You can refresh cardinality statistics
by calling the procedure SYSCS_UTIL.SYSCS_UPDATE_STATISTICS. For information
about this procedure, see the <span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Reference Manual</span></span>.</div></div></div></div></div><div><a name="N14EF3"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="ctuntransform13966"></a><div></div>Internal language transformations</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> SQL parser sometimes transforms SQL statements
internally for performance reasons. This appendix describes those transformations.
Understanding the internal language transformations can help you analyze and
tune performance. Understanding the internal language transformations is not
necessary for the general user.  
<div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This chapter uses some specialized terms. Here are some
definitions:</div><div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">base table</span></div><div style="font-size: 10pt; margin-top: 0.3em; margin-bottom: 0.5em; margin-left: 2em;">A real table in a FROM list. In queries that involve "virtual"
tables such as views and derived tables, base tables are the underlying tables
to which virtual tables correspond.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">derived table</span></div><div style="font-size: 10pt; margin-top: 0.3em; margin-bottom: 0.5em; margin-left: 2em;">A virtual table, such as a subquery given a correlation name or a view.
For example:<span style="font-style: italic;"> SELECT derivedtable.c1 FROM (VALUES ('a','b'))
AS derivedtable(c1,c2)</span>.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">equality predicate</span></div><div style="font-size: 10pt; margin-top: 0.3em; margin-bottom: 0.5em; margin-left: 2em;">A <span style="color: blue;"><a href="#rtuntransform25022">predicate</a></span> in which one value is
compared to another value using the = operator.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">equijoin predicate</span></div><div style="font-size: 10pt; margin-top: 0.3em; margin-bottom: 0.5em; margin-left: 2em;">A predicate in which one column is compared to a column in another table
using the = operator.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">optimizable</span></div><div style="font-size: 10pt; margin-top: 0.3em; margin-bottom: 0.5em; margin-left: 2em;">A predicate is <span style="font-style: italic;">optimizable</span> if it provides a
starting or stopping point and allows use of an index. Optimizable predicates
use only <span style="color: blue;"><a href="#rtuntransform13785">simple column reference</a></span>s and =, &lt;, &gt;, +, &gt;=,
and IS NULL operators. For complete details, see <span style="color: blue;"><a href="#ctunoptimz39106">What's optimizable?</a></span>. A synonym for <span style="font-style: italic;">optimizable</span> is  <span style="font-style: italic;">indexable</span>.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">predicate</span></div><div style="font-size: 10pt; margin-top: 0.3em; margin-bottom: 0.5em; margin-left: 2em;">A WHERE clause contains boolean expressions that can be linked together
by AND or OR clauses. Each part is called a <span style="font-style: italic;">predicate</span>.
For example: <span style="font-style: italic;">WHERE c1 =2 AND c2 = 5</span> contains two predicates.</div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">sargable</span></div><div style="font-size: 10pt; margin-top: 0.3em; margin-bottom: 0.5em; margin-left: 2em;"><span style="font-style: italic;">Sargable</span> predicates are a superset of optimizable
predicates; not all sargable predicates are optimizable, because sargable
predicates also include the &lt;&gt; operator. (<span style="font-style: italic;">Sarg</span> stands
for "search argument.") Predicates that are sargable but not optimizable
nevertheless improve performance and allow the optimizer to use more accurate
costing information.   
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In addition, sargable predicates can be <span style="font-style: italic;">pushed down </span>(see <span style="color: blue;"><a href="#ctuntransform36623">Predicates pushed into views or derived tables</a></span>).</div></div></div><div><div style="font-size: 10pt; font-weight: bold; text-indent: 0em; margin-right: 24pt;"><span style="font-weight: bold;">simple column reference</span></div><div style="font-size: 10pt; margin-top: 0.3em; margin-bottom: 0.5em; margin-left: 2em;">A reference to a column that is not part of an expression. For example, <span style="font-style: italic;">c1</span> is a simple column reference, but <span style="font-style: italic;">c1+1,</span><span style="font-style: italic;">max(c1)</span>, and <span style="font-style: italic;">lower(c1)</span> are not.</div></div></div></div></td></tr></tbody></table></div></div></div><div><a name="N150EF"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctuntransform35783"></a><div></div>Predicate transformations</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">WHERE clauses with <span style="color: blue;"><a href="#rtuntransform25022">predicate</a></span>s joined
by OR are usually not optimizable. WHERE clauses with predicates joined by
AND are optimizable if <span style="font-style: italic;">at least one</span> of the predicates
is optimizable. For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights
WHERE flight_id = 'AA1111'
AND segment_number &lt;&gt; 2</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">In this example, the first predicate is optimizable; the second predicate
is not. Therefore, the statement is optimizable.  
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  In a few
cases, a WHERE clause with predicates joined by OR can be transformed into
an optimizable statement. See <span style="color: blue;"><a href="#rtuntransform590">OR transformations</a></span>.</div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can transform some predicates internally so that at least one
of the predicates is optimizable and thus the statement is optimizable. This
section describes the predicate transformations that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> performs
to make predicates optimizable.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A predicate that uses the following comparison operators can sometimes
be transformed internally into optimizable predicates. 
</div></div><div><a name="N1520C"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="rtuntransform139"></a><div></div>BETWEEN transformations</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15230"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">A BETWEEN predicate is transformed into equivalent predicates that use
the &gt;= and &lt;= operators, which are optimizable. For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">flight_date BETWEEN DATE('2005-04-01') and DATE('2005-04-10')</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15243"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">is transformed into  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">flight_date &gt;= DATE('2005-04-01')
AND flight_date &gt;= '2005-04-10'</span></div></pre></div></div></div></div><div><a name="N152AA"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="rtuntransform208"></a><div></div>LIKE transformations</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N152CE"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This section describes using LIKE transformations as a comparison operator.
</div><div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  LIKE transformations and optimizations are disabled when you use
territory-based collation. See "Character-based collation in
<span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>" in the
<span style="border-right-width: 0pt; border-left-width: 0pt;"><span style="font-style: italic;">Java DB Developer's Guide</span></span> for information about
territory-based collation.</div></div></div><div><a name="N1536F"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="rtuntransform345"></a><div></div>Character string beginning with constant</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1537C"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">A LIKE predicate in which a column is compared to a character string that <span style="font-style: italic;">begins</span> with a character constant (not a wildcard) is transformed
into three predicates: one predicate that uses the LIKE operator, one that
uses the &gt;= operator, and one that uses the &lt; operator. For example:
  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country LIKE 'Ch%i%'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15395"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">becomes   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country LIKE 'Ch%i%'
AND country &gt;= 'Ch'
AND country &lt; 'Ci'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N153A8"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The first (LIKE) predicate is not optimizable, but the new predicates added
by the transformation are.</div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N153B1"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When the character string begins with one more character constants and
ends with a single "%", the first LIKE clause is eliminated. For example:
 
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country LIKE 'Ch%'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N153C4"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">becomes  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country &gt;= 'Ch'
AND country &lt; 'Ci'</span></div></pre></div></div></div></div><div><a name="N15411"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="rtuntransform443"></a><div></div>Character string without wildcards</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1541E"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">A LIKE predicate is transformed into a predicate that uses the = operator
(and a NOT LIKE predicate is transformed into one that uses &lt;&gt;) when
the character string does not contain any wildcards. For example:   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country LIKE 'Chile'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15431"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">becomes  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country = 'Chile'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15444"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">and  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country NOT LIKE 'Chile'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15457"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">becomes  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country &lt;&gt; 'Chile'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1546A"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Predicates that use the = operator are <span style="color: blue;"><a href="#rtuntransform19435">optimizable</a></span>. Predicates that use the &lt;&gt; operator are <span style="color: blue;"><a href="#rtuntransform26698">sargable</a></span>.</div></div></div></div><div><a name="N154BB"></a><div style="font-size: 9pt; font-weight: bold; margin-left: 72pt;"><a name="rtuntransform472"></a><div></div>Unknown parameter</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N154C8"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">'The situation is similar to those described above when a column is compared
using the LIKE operator to a parameter whose value is unknown in advance (dynamic
parameter, join column, etc.).</div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N154D1"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">In this situation, the LIKE predicate is likewise transformed into three
predicates: one LIKE predicate, one predicate using the &gt;= operator, and
one predicate using the &lt; operator. For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country LIKE ?</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N154E4"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">is transformed into  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">country LIKE ?
AND country &gt;= <span style="font-weight: bold;"><span style="font-style: italic;">InternallyGeneratedParameter</span></span>
AND country &lt; <span style="font-weight: bold;"><span style="font-style: italic;">InternallyGeneratedParameter</span></span></span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1550A"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">where the <span style="font-style: italic;">InternallyGeneratedParameters</span> are calculated
at the beginning of execution based on the value of the parameter.   
<div><span style="font-weight: bold; border-right-width: 0pt; border-left-width: 0pt;">Note: </span>  This transformation can lead to a bad plan if the user passes in
a string that begins with a wildcard or a nonselective string as the parameter.
Users can work around this possibility by writing the query like this (which
is not optimizable):  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">(country || '') LIKE ?</span></div></pre></div></div></div></div></div></div><div><a name="N15562"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="rtuntransform582"></a><div></div>Simple IN predicate transformations</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em; margin-left: 72pt;"></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15594"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A <span style="border-right-width: 0pt; border-left-width: 0pt;">simple</span> IN list predicate is a predicate where the
left operand is a <span style="color: blue;"><a href="#rtuntransform13785">simple
column reference</a></span> and the IN list is composed entirely of constants
or parameter markers. The following are examples of simple IN predicates:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">    orig_airport IN ('ABQ', 'AKL', 'DSM')

    orig_airport IN (?, ?, ?)

    orig_airport IN ('ABQ', ?, ?, 'YYZ') </div></pre></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N155B0"></a><span></span><div style="font-weight: bold;">Probe predicates</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> transforms
each IN list predicate into an equality predicate whose right operand is a
parameter marker that is created internally. This internal equality predicate
is called a <span style="border-right-width: 0pt; border-left-width: 0pt;">probe predicate</span>. Each of the above examples of simple
IN predicates is transformed into the following probe predicate:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">    orig_airport = ?</div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Probe
predicates are treated differently than normal equality predicates. Probe
predicates are processed in a special way during query optimization and execution. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">During
optimization, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> analyzes
the probe predicate to determine if the probe predicate is useful for limiting
the number of rows retrieved from disk. For a probe predicate to be useful,
both of the following requirements must be true:</div><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div>1. 
          </div></td><td width="8">&nbsp;</td><td valign="top"><div>There must be an index defined on the table that the column reference
belongs to, and the column reference must be the first column in the index.
In the example above, <span style="font-family: Courier;">orig_airport</span> is the column reference.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div>2. 
          </div></td><td width="8">&nbsp;</td><td valign="top"><div>The estimated cost of an access path that uses the probe predicate and
one of the corresponding indexes must be less than the estimated cost of any
other access paths calculated by the optimizer.  Typically, this means that
the number of values in the IN list is significantly fewer than the number
of rows in the table that the column reference belongs to.</div></td></tr></table></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If both of these requirements are met, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will
use the probe predicate at query execution to <span style="font-style: italic;">probe</span> the underlying
index for values in the IN list. In other words, the right operand of the
probe predicate (the parameter) becomes a place-holder into which <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> plugs
the different values from the IN list. Then for each value, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> reads
the matching rows from the index.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If either of the two requirements
is not satisfied, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> discards
the internal probe predicate and executes the query using the original IN
list predicate.</div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1561B"></a><span></span><div style="font-weight: bold;">Examples</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The following query is submitted to <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span>:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">SELECT flights.orig_airport, cities.city_name 
    FROM flights, cities
    WHERE flights.orig_airport IN ('ABQ', 'DSM', 'YYZ')
        AND flights.orig_airport = cities.airport   </div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The Derby
optimizer transforms this query internally into:     </div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">SELECT flights.orig_airport, cities.city_name
    FROM flights, cities
    WHERE flights.orig_airport = ?
        AND flights.orig_airport = cities.airport   </div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In this
transformed query <span style="font-family: Courier;">flights.orig_airport = ?</span> is an internal
probe predicate.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">There is an index on the <span style="font-family: Courier;">org_airport</span> column
in the <span style="font-family: Courier;">flights</span> table. If the estimated cost of probing that
index for the three values (ABQ, DSM, YYZ) is less than the cost of accessing
the <span style="font-family: Courier;">flights</span> table in some other way, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will
perform probing on the index at query execution. This approach ensures that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> reads only the necessary
rows from the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">At
a higher level, the approach by <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> to
use index probing for IN lists is an internal way of evaluating the transformed
predicate multiple times. The predicate is evaluated one time for each value
in the IN list.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">From a JDBC perspective, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is
logically (but not actually) performing the following statements and then
combining the three result sets (rs1, rs2, and rs3) : <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">PreparedStatement ps = conn.prepareStatement(
    "select flights.orig_airport, cities.city_name " +
    "from flights, cities " +
    "where flights.orig_airport = ? " +
        "and flights.orig_airport = cities.airport ");

ps.setString(1, "ABQ");
rs1 = ps.executeQuery();

ps.setString(1, "DSM");
rs2 = ps.executeQuery();

ps.setString(1, "YYZ");
rs3 = ps.executeQuery();

</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">From an SQL perspective, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is
logically (but not actually) performing the following statement:</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">SELECT flights.orig_airport, cities.city_name
    FROM flights, cities
    WHERE flights.orig_airport = 'ABQ'
        AND flights.orig_airport = cities.airport

UNION ALL

SELECT flights.orig_airport, cities.city_name
    FROM flights, cities
    WHERE flights.orig_airport = 'DSM'
        AND flights.orig_airport = cities.airport

UNION ALL

SELECT flights.orig_airport, cities.city_name
    FROM flights, cities
    WHERE flights.orig_airport = 'YYZ'
        AND flights.orig_airport = cities.airport
    </div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In the above SQL example, for each subquery the equality
predicate limits the number of rows read from the <span style="font-family: Courier;">flights</span> table
so that the process avoids having to read unnecessary rows from disk. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The
larger the <span style="font-family: Courier;">flights</span> table, the more time <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will
save by probing the index for the relatively few IN list values. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">By
using probe predicates, regardless of how large the base table is, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> only
has to probe the index a maximum of N times, where N is the size of the IN
list. If N is significantly less than the number of rows in the table, or
is significantly less than the number of rows between the minimum value and
the maximum value in the IN list, selective probing ensures that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> does
not spend time reading unnecessary rows from disk.</div></div></div></div><div><a name="N15724"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="rtuntransform866214"></a><div></div>NOT IN predicate transformations</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15731"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">NOT IN lists are transformed into multiple predicates that use
the &lt;&gt; operator. &lt;&gt; predicates are not optimizable, but they are sargable
(See <span style="color: blue;"><a href="#ctuntransform13966">Internal language transformations</a></span>).
For example:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">orig_airport NOT IN ('ABQ', 'AKL', 'DSM')</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1574C"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">becomes   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">orig_airport &lt;&gt; 'ABQ'
AND orig_airport &lt;&gt; 'AKL'
AND orig_airport &lt;&gt; 'DSM'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1575F"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In addition, large lists are sorted in ascending order for performance
reasons.</div></div></div></div><div><a name="N157BC"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="rtuntransform590"></a><div></div>OR transformations</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N157E0"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">If all the OR predicates in a WHERE clause are of the form  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="font-weight: bold;"><span style="font-style: italic;"><span style="color: blue;"><a href="#rtuntransform13785">simple column reference</a></span></span></span> = <span style="font-weight: bold;"><span style="font-style: italic;">Expression</span></span></span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1580A"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">where the <span style="font-weight: bold;"><span style="font-style: italic;">columnReference</span></span> is the same for
all predicates in the OR chain, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> transforms the OR chain into an
IN list of the following form:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="font-weight: bold;"><span style="font-style: italic;"><span style="color: blue;"><a href="#rtuntransform13785">simple column reference</a></span></span></span> IN (<span style="font-weight: bold;"><span style="font-style: italic;">Expression1</span></span>, <span style="font-weight: bold;"><span style="font-style: italic;">Expression2</span></span>, ..., <span style="font-weight: bold;"><span style="font-style: italic;">ExpressionN</span></span>)</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15859"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The new predicate might be optimizable.</div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15862"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can transform the following statement:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights
WHERE flight_id = 'AA1111'
OR flight_id = 'US5555'
OR flight_id = ?</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1587B"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">into this one:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights
WHERE flight_id IN ('AA1111', 'US5555', ?)</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N1588E"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If this transformed IN list is a static IN list, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> also performs
the static IN list transformation (see <span style="color: blue;"><a href="#rtuntransform582">Simple IN predicate transformations</a></span>).</div></div></div></div></div><div><a name="N158F9"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctuntransform37032"></a><div></div>Transitive closure</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The transitive property of numbers states that if A = B and B = C, then
A = C.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> applies this property to query predicates to add additional
predicates to the query in order to give the optimizer more information. This
process is called <span style="font-style: italic;">transitive closure</span>. There are two
types of transitive closure:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Transitive closure on join clauses  
<div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Applied first, if applicable</div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Transitive closure on search clauses</div></td></tr></table></div></div></div><div><a name="N159D8"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="rtuntransform866547"></a><div></div>Transitive closure on join clauses</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N159E5"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When a join statement selects from three or more tables, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> analyzes
any <span style="color: blue;"><a href="#rtuntransform36163">equijoin predicate</a></span>s between <span style="color: blue;"><a href="#rtuntransform13785">simple column reference</a></span>s within each query block and adds additional <span style="color: blue;"><a href="#rtuntransform36163">equijoin predicate</a></span>s where possible if they do not currently exist. For example, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> transforms
the following query:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM samp.employee e, samp.emp_act a, samp.emp_resume r
WHERE e.empno = a.empno
and a.empno = r.empno</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15A19"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">into the following:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM samp.employee e, samp.emp_act a, samp.emp_resume r
WHERE e.empno = a.empno
and a.empno = r.empno
and e.empno = r.empno</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15A2C"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">On the other hand, the optimizer knows that one of these <span style="color: blue;"><a href="#rtuntransform36163">equijoin predicate</a></span>s is redundant and will throw out the one that is least useful
for optimization.</div></div></div></div><div><a name="N15A68"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="rtuntransform866587"></a><div></div>Transitive Closure on Search Clauses</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15A75"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> applies transitive closure on search clauses after transitive
closure on join clauses. For each <span style="color: blue;"><a href="#rtuntransform26698">sargable</a></span> predicate
where a <span style="color: blue;"><a href="#rtuntransform13785">simple column reference</a></span> is compared with a constant
(or the IS NULL and IS NOT NULL operators), <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> looks for an <span style="color: blue;"><a href="#rtuntransform36163">equijoin predicate</a></span> between the simple column reference
and a simple column reference from another table in the same query block.
For each such <span style="color: blue;"><a href="#rtuntransform36163">equijoin predicate</a></span>, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> then
searches for a similar comparison (the same operator) between the column from
the other table and the same constant. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> adds a new predicate if
no such predicate is found.</div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15AB1"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> performs all other possible transformations on the predicates
(described in <span style="color: blue;"><a href="#ctuntransform35783">Predicate transformations</a></span>) before applying
transitive closure on search clauses.</div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15AC7"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, given the following statement:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights, FlightAvailability
WHERE Flights.flight_id = FlightAvailability.flight_id
AND Flights.flight_id between 'AA1100' and 'AA1250'
AND Flights.flight_id &lt;&gt; 'AA1219'
AND FlightAvailability.flight_id &lt;&gt; 'AA1271' </span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15ADA"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> first performs any other transformations:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>the BETWEEN transformation on the second predicate:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">AND Flights.flight_id &gt;= 'AA1100' 
AND Flights.flight_id &lt;=  'AA1250'</span></div></pre></div></td></tr></table></div></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15AFB"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> then performs the transitive closure:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights, FlightAvailability
WHERE Flights.flight_id = FlightAvailability.flight_id
AND Flights.flight_id &gt;= 'AA1100' 
AND Flights.flight_id &lt;=  'AA1250'
AND Flights.flight_id &lt;&gt; 'AA1219'
AND Flights.flight_id &lt;&gt; 'AA1271'
AND FlightAvailability.flight_id &gt;= 'AA1100' 
AND FlightAvailability.flight_id &lt;=  'AA1250'
AND FlightAvailability.flight_id &lt;&gt; 'AA1271'
AND FlightAvailability.flight_id &lt;&gt; 'AA1219'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15B13"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When a sargable predicate uses the = operator, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can remove all <span style="color: blue;"><a href="#rtuntransform36163">equijoin predicate</a></span>s comparing that column reference to
another simple column reference from the same query block as part of applying
transitive closure, because the <span style="color: blue;"><a href="#rtuntransform36163">equijoin predicate</a></span> is
now redundant, whether or not a new predicate was added. For example:   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights, Flightavailability
WHERE Flights.flight_id = Flightavailability.flight_id
AND Flightavailability.flight_id = 'AA1122'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15B3A"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">becomes (and is equivalent to)  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Flights, Flightavailability
WHERE Flights.flight_id = 'AA1122'
AND Flightavailability.flight_id = 'AA1122'</span></div></pre></div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15B4D"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The elimination of redundant predicates gives the optimizer more accurate
selectivity information and improves performance at execution time.</div></div></div></div></div><div><a name="N15B82"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctuntransform11313"></a><div></div>View transformations</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">When <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> evaluates a statement that references a view, it transforms
the reference to a view into a derived table. It might make additional transformations
to improve performance.  
</div></div><div><a name="N15C44"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform22576"></a><div></div>View flattening</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">When evaluating a statement that references a view, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> internally
transforms a view into a derived table. This derived table might also be a
candidate for <span style="font-style: italic;">flattening</span> into the outer query block.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">A view or derived table can be flattened into the outer query block if
all of the following conditions are met:   
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The select list is composed entirely of <span style="color: blue;"><a href="#rtuntransform13785">simple column reference</a></span>s and constants.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>There is no GROUP BY clause in the view. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>There is no DISTINCT in the view. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>There is no ORDER BY, result offset, or fetch first clause in the view.</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, given view <span style="font-style: italic;">v1(a,b):</span><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT Cities.city_name, Countries.country_iso_code
FROM Cities, Countries
WHERE Cities.country_iso_code = Countries.country_iso_code</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">and a SELECT that references it:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT a, b
FROM v1 WHERE a = 'Melbourne'</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">after the view is transformed into a derived table, the internal query
is  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT a, b
FROM (select Cities.city_name, Countries.country_iso_code
FROM Cities, Countries
WHERE Cities.country_iso_code = Countries.country_iso_code) v1(a, b)
WHERE a = 'Melbourne'</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">After view flattening it becomes  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT Cities.city_name, Countries.country_iso_code
FROM Cities, Countries
WHERE Cities.country_iso_code = Countries.country_iso_code
AND Cities.city_name = 'Melbourne'</span></div></pre></div></div></div><div><a name="N15D00"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform36623"></a><div></div>Predicates pushed into views or derived tables</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">An SQL statement that references a view can also include a predicate. Consider
the view <span style="font-style: italic;">v2 (a,b)</span>:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">CREATE VIEW v2(a,b) AS
SELECT sales_person, MAX(sales)
FROM Sales
GROUP BY sales_person</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following statement references the view and includes a predicate: 
 <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">SELECT *
FROM v2
WHERE a = 'LUCCHESSI'</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> transforms
that statement by first transforming the view into a derived table, it places
the predicate at the top level of the new query, outside the scope of the
derived table:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">SELECT a, b 
FROM (SELECT sales_person, MAX(sales) 
   FROM Sales 
   WHERE sales_person = 'LUCCHESSI' 
   GROUP BY sales_person) 
   v1(a, b)
</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In the example in the preceding section (see <span style="color: blue;"><a href="#ctuntransform22576">View flattening</a></span>), <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> was able to flatten the
derived table into the main SELECT, so the predicate in the outer SELECT could
be evaluated at a useful point in the query. This is not possible in this
example, because the underlying view does not satisfy all the requirements
of view flattening.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">However, if the source of all of the column references in a predicate is
a <span style="color: blue;"><a href="#rtuntransform13785">simple
column reference</a></span> in the underlying view or table, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is
able to <span style="font-style: italic;">push</span> the predicate <span style="font-style: italic;">down</span> to the underlying view. Pushing
down means that the qualification described by the predicate can be evaluated
when the view is being evaluated. In our example, the column reference in
the outer predicate, <span style="font-style: italic;">a</span>, in the underlying view is a <span style="color: blue;"><a href="#rtuntransform13785">simple
column reference</a></span> to the underlying <span style="color: blue;"><a href="#rtuntransform41494">base
table</a></span>. So the final transformation of this statement after predicate
pushdown is: <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">SELECT a, b 
FROM (SELECT sales_person, MAX(sales) from Sales 
WHERE sales_person = 'LUCCHESSI' 
GROUP BY sales_person) v1(a, b)</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Without the transformation, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> would
have to scan the entire table <span style="font-style: italic;">t1</span> to form all the groups, only to throw
out all but one of the groups. With the transformation, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> is
able to make that qualification part of the derived table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">If there were a predicate that referenced column <span style="font-style: italic;">b</span>, it could not
be pushed down, because in the underlying view, column <span style="font-style: italic;">b</span> is not a <span style="color: blue;"><a href="#rtuntransform13785">simple
column reference</a></span>.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Predicate pushdown transformation includes predicates that reference multiple
tables from an underlying join.</div></div></div></div><div><a name="N15DF7"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctuntransform13699"></a><div></div>Subquery processing and transformations</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Subqueries are notoriously expensive to evaluate. This section describes
some of the transformations that <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> makes internally to reduce the
cost of evaluating them.  
</div></div><div><a name="N15EEB"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform25857"></a><div></div>Materialization</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em; margin-left: 72pt;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Materialization</span> means that a subquery is evaluated
only once. There are several types of subqueries that can be materialized.</div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15F1E"></a><span></span><div style="font-weight: bold;">Expression subqueries that are not correlated</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A
subquery can be materialized if it is a noncorrelated expression subquery.
A correlated subquery is one that references columns in the outer query, and
so has to be evaluated for each row in the outer query.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example:
   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM Staff WHERE id = (SELECT MAX(manager) FROM Org)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">In
this statement, the subquery needs to be evaluated only once.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This type
of subquery must return only one row. If evaluating the subquery causes a
cardinality violation (if it returns more than one row), an exception is thrown
when the subquery is run. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Subquery materialization is detected before
optimization, which allows the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> optimizer
to see a materialized subquery as an unknown constant value. The comparison
is therefore optimizable. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The original statement is transformed into
the following two statements:    <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;"><span style="font-style: italic;">constant</span></span> = SELECT MAX(manager) FROM Org
SELECT * FROM Staff
WHERE id = <span style="font-weight: bold;"><span style="font-style: italic;">constant</span></span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The second statement is
optimizable.</div></div><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N15F72"></a><span></span><div style="font-weight: bold;">Subqueries that cannot be flattened</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Materialization
of a subquery can also occur when the subquery is nonflattenable and there
is an equijoin between the subquery and another FROM table in the query. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For
example:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">SELECT i, a  FROM t1, 
   (SELECT DISTINCT a FROM T2) x1  
WHERE t1.i = x1.a AND t1.i in (1, 3, 5, 7) </div></pre>In this example, the
subquery x1 is noncorrelated because it does not reference any of the columns
from the outer query. The subquery is nonflattenable because of the DISTINCT
keyword. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> does not
flatten DISTINCT subqueries. This subquery is eligible for materialization.
Since there is an equijoin predicate between the subquery x1 and the table
t1 (namely, t1.i = x1.a), the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> optimizer
will consider performing a hash join between t1 and x1 (with x1 as the inner
operand). If that approach yields the best cost, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> materializes
the subquery x1 to perform the hash join. The subquery is evaluated only a
single time and the results are stored in an in-memory hash table. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> then
executes the join using the in-memory result set for x1.</div></div></div></div><div><a name="N16008"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform36368"></a><div></div>Flattening a subquery into a normal join</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Subqueries are allowed to return more than one row when used with IN, EXISTS,
and ANY. However, for each row returned in the outer row, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> evaluates
the subquery until it returns one row; it does not evaluate the subquery for
all rows returned.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example, given two tables, <span style="font-style: italic;">t1</span> and <span style="font-style: italic;">t2</span>:  
<div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><thead><tr><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>c1</div></td></tr></thead><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>1</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>2</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>3</div></td></tr></tbody></table></div><div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><thead><tr><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>c1</div></td></tr></thead><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>2</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>2</div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div>1</div></td></tr></tbody></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">and the following query:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT c1 FROM t1 WHERE c1 IN (SELECT c1 FROM t2)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">the results would be  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">1
2</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Simply selecting <span style="font-style: italic;">t1.c1</span> when simply joining those
tables has different results:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT t1.c1 FROM t1, t2 WHERE t1.c1 = t2.c1
   1
   2
   2</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Statements that include such subqueries can be flattened into joins only
if the subquery does not introduce any duplicates into the result set (in
our example, the subquery introduced a duplicate and so cannot simply be flattened
into a join). If this requirement and other requirements (listed below) are
met, however, the statement is flattened such that the tables in the subquery's
FROM list are treated as if they were inner to the tables in the outer FROM
list.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">For example, the query could have been flattened into a join if <span style="font-style: italic;">c1</span> in <span style="font-style: italic;">t2</span> had a unique index on it. It would not
have introduced any duplicate values into the result set.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The requirements for flattening into a normal join are:   
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery is not under an OR. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery type is EXISTS, IN, or ANY, or it is an expression subquery
on the right side of a comparison operator. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery is not in the SELECT list of the outer query block. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>There are no aggregates in the SELECT list of the subquery. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery does not have a GROUP BY clause. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery does not have an ORDER BY, result offset, or fetch first
clause.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>There is a uniqueness condition that ensures that the subquery does not
introduce any duplicates if it is flattened into the outer query block. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Each table in the subquery's FROM list (after any view, derived table,
or subquery flattening) must be a <span style="color: blue;"><a href="#rtuntransform41494">base table</a></span>.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>If there is a WHERE clause in the subquery, there is at least one table
in the subquery whose columns are in <span style="color: blue;"><a href="#rtuntransform24389">equality predicate</a></span>s
with expressions that do not include any column references from the subquery
block. These columns must be a superset of the key columns for any unique
index on the table. For all other tables in the subquery, the columns in equality
predicates with expressions that do not include columns from the same table
are a superset of the unique columns for any unique index on the table.</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Flattening into a normal join gives the optimizer more options for choosing
the best query plan. For example, if the following statement:   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT huge.* FROM huge
WHERE c1 IN (SELECT c1 FROM tiny)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">can be flattened into  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT huge.* FROM huge, tiny WHERE huge.c1 = tiny.c1</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">the optimizer can choose a query plan that will scan <span style="font-style: italic;">tiny</span> and do a few probes into the huge table instead of scanning the
huge table and doing a large number of probes into the tiny table. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Here is an expansion of the example used earlier in this section. Given
 
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">CREATE TABLE t1 (c1 INT)
CREATE TABLE t2 (c1 INT NOT NULL PRIMARY KEY)
CREATE TABLE t3 (c1 INT NOT NULL PRIMARY KEY)
INSERT INTO t1 VALUES (1), (2), (3)
INSERT INTO t2 VALUES (1), (2), (3)
INSERT INTO t3 VALUES (2), (3), (4)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">this query  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT t1.* FROM t1 WHERE t1.c1 IN 
    (SELECT t2.c1 FROM t2, t3 WHERE t2.c1 = t3.c1)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">should return the following results:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;">2
3</div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The query satisfies all the requirements for flattening into a join, and
the statement can be transformed into the following one:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT t1.*
FROM t1, t2, t3
WHERE t1.c1 = t2.c1
AND t2.c1 = t3.c1
AND t1.c1 = t3.c1</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The following query:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT t1.*
FROM t1 WHERE EXISTS
(SELECT * FROM t2, t3 WHERE t2.c1 = t3.c1 AND t2.c1 = t1.c1)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">can be transformed into  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT t1.*
FROM t1, t2, t3
WHERE t1.c1 = t2.c1
AND t2.c1 = t3.c1
AND t1.c1 = t3.c1</span></div></pre></div></div></div><div><a name="N16236"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform25868"></a><div></div>Flattening a subquery into an EXISTS join</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">An EXISTS join is a join in which the right side of the join needs to be
probed only once for each outer row. Using such a definition, an EXISTS join
does not literally use the EXISTS keyword. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> treats a statement
as an EXISTS join when there will be at most one matching row from the right
side of the join for a given row in the outer table.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A subquery that cannot be flattened into a normal join because of a uniqueness
condition can be flattened into an EXISTS join if it meets all the requirements
(see below). Recall the first example from the previous section (<span style="color: blue;"><a href="#ctuntransform36368">Flattening a subquery into a normal join</a></span>):</div><pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT c1 FROM t1 WHERE c1 IN (SELECT c1 FROM t2)</span></div></pre><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">This query could not be flattened into a normal join because such a join
would return the wrong results. However, this query can be flattened into
a join recognized internally by the <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> system as an EXISTS join.
When processing an EXISTS join, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> knows to stop processing the right
side of the join after a single row is returned. The transformed statement
would look something like this:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT c1 FROM t1, t2
WHERE t1.c1 = t2.c1
EXISTS JOIN INTERNAL SYNTAX</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Requirements for flattening into an EXISTS join:   
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery is not under an OR. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery type is EXISTS, IN, or ANY. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery is not in the SELECT list of the outer query block. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>There are no aggregates in the SELECT list of the subquery. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery does not have a GROUP BY clause. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery does not have an ORDER BY, result offset, or fetch first
clause.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The subquery has a single entry in its FROM list that is a <span style="color: blue;"><a href="#rtuntransform41494">base table</a></span>. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>None of the predicates in the subquery, including the additional one formed
between the left side of the subquery operator and the column in the subquery's
SELECT list (for IN or ANY subqueries), include any subqueries, method calls,
or field accesses. </div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">When a subquery is flattened into an EXISTS join, the table from the subquery
is made join-order-dependent on all the tables with which it is correlated.
This means that a table must appear inner to all the tables on which it is
join-order-dependent. (In subsequent releases this restrictions can be relaxed.)
For example:   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT t1.* FROM t1, t2
WHERE EXISTS (SELECT * FROM t3 WHERE t1.c1 = t3.c1)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">gets flattened into  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT t1.* FROM t1, t2, t3 WHERE t1.c1 = t3.c1</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">where <span style="font-style: italic;">t3</span> is join order dependent on <span style="font-style: italic;">t1</span>. This means that the possible join orders are (<span style="font-style: italic;">t1</span>, <span style="font-style: italic;">t2</span>, <span style="font-style: italic;">t3</span>), (<span style="font-style: italic;">t1</span>, <span style="font-style: italic;">t3</span>, <span style="font-style: italic;">t2</span>), and (<span style="font-style: italic;">t2</span>, <span style="font-style: italic;">t1</span>, <span style="font-style: italic;">t3</span>).</div></div></div><div><a name="N1639C"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform47182"></a><div></div>Flattening VALUES subqueries</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> flattens VALUES subqueries to improve performance.</div></div></div><div><a name="N16416"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform867165"></a><div></div>DISTINCT elimination in IN, ANY, and EXISTS subqueries</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">An IN, ANY, or EXISTS subquery evaluates to true if there is at least one
row that causes the subquery to evaluate to true. These semantics make a DISTINCT
within an IN, ANY, or EXISTS subquery unnecessary. The following two queries
are equivalent and the first is transformed into the second:   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT * FROM t1 WHERE c1 IN
    (SELECT DISTINCT c2 FROM t2 WHERE t1.c3 = t2.c4)

SELECT * FROM t1 WHERE c1 IN
    (SELECT c2 FROM t2 WHERE t1.c3 = t2.c4)</span></div></pre></div></div></div><div><a name="N164A7"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform867201"></a><div></div>IN/ANY subquery transformation</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">An IN or ANY subquery that is guaranteed to return at most one row can
be transformed into an equivalent expression subquery (a scalar subquery without
the IN or ANY). The subquery must not be correlated. Subqueries guaranteed
to return at most one row are:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Simple VALUES clauses</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>SELECTs returning a non-grouped aggregate</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">WHERE C1 IN (SELECT MIN(c1) FROM T)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">can be transformed into  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">WHERE C1 = (SELECT MIN(c1) FROM T)</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">This transformation is considered before subquery materialization. If the
transformation is performed, the subquery becomes materializable. In the example,
if the IN subquery were not transformed, it would be evaluated anew for each
row.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The subquery type transformation is shown in <span style="color: blue;"><a href="#rtuntransform52953">IN or ANY Subquery Transformations for Subqueries Returning a Single Row</a></span>:  
<div><div style="font-weight: bold;"><span style="color: red;">Table 3. </span>IN or ANY Subquery Transformations for Subqueries
Returning a Single Row</div><table style="margin-top: 12pt; margin-bottom: 10pt; background-color: white; border-style: solid; border-width: 1pt; border-color: black;" valign="top"><thead><tr><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>Before Transformation</div></td><td style="border-style: solid; border-width: 1pt; border-color: black; font-weight: bold; text-align: center; padding: 2pt; background-color: silver; margin-left: 2pt;" valign="top"><div>After Transformation</div></td></tr></thead><tbody><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 IN (SELECT ...)</span></span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 = (SELECT ...)</span></span></div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 = ANY (SELECT ...)</span></span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 = (SELECT ...)</span></span></div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &lt;&gt; ANY (SELECT ...)</span></span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &lt;&gt; (SELECT ...)</span></span></div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &gt; ANY (SELECT ...)</span></span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &gt; (SELECT ...)</span></span></div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &gt;= ANY (SELECT ...)</span></span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &gt;= (SELECT ...)</span></span></div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &lt; ANY (SELECT ...)</span></span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &lt; (SELECT ...)</span></span></div></td></tr><tr><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &lt;= ANY (SELECT ...)</span></span></div></td><td style="border-style: solid; border-width: 1pt; border-color: black; padding: 2pt; background-color: #faf4fa; margin-left: 2pt;" valign="top"><div><span style="font-weight: bold;"><span style="font-family: Courier;">c1 &lt;= (SELECT ...)</span></span></div></td></tr></tbody></table></div></div></div></div></div><div><a name="N1667F"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctuntransform55045"></a><div></div>Outer join transformations</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> transforms OUTER to INNER joins when the predicate filters
out all nulls on the join column. This transformation can allow more potential
query plans and thus better performance.</div></div></div><div><a name="N16708"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctuntransform16033"></a><div></div>Sort avoidance</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Sorting is an expensive process. <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> tries to eliminate unnecessary
sorting steps where possible.  
</div></div><div><a name="N167D8"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform16279"></a><div></div>DISTINCT elimination based on a uniqueness condition</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A DISTINCT (and the corresponding sort) can be eliminated from a query
if a uniqueness condition exists that ensures that no duplicate values will
be returned. If no duplicate values are returned, the DISTINCT node is superfluous,
and <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> transforms the
statement internally into one without the DISTINCT keyword.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">The requirements are:   <div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>No GROUP BY list. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>SELECT list contains at least one <span style="color: blue;"><a href="#rtuntransform13785">simple
column reference</a></span>. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Every <span style="color: blue;"><a href="#rtuntransform13785">simple
column reference</a></span> is from the same table. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>Every table in the FROM list is a <span style="color: blue;"><a href="#rtuntransform41494">base
table</a></span>. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><a name="rtuntransform29680"></a><div></div>Primary table</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">There is
at least one unique index on one table in the FROM list for which <span style="font-style: italic;">all</span> the
columns appear in one of the following:</div><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="color: blue;"><a href="#rtuntransform24389">equality
predicate</a></span>s with expressions that do not include any column references</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="color: blue;"><a href="#rtuntransform13785">simple
column reference</a></span>s in the SELECT list</div></td></tr></table></div></div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="font-style: italic;"><a name="rtuntransform16930"></a><div></div>Secondary table(s)</span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">All
the other tables in the FROM list also have at least one unique index for
which all the columns appear in one of the following:</div><div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="color: blue;"><a href="#rtuntransform24389">equality
predicate</a></span>s with expressions that do not include columns from the same
table</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div><span style="color: blue;"><a href="#rtuntransform13785">simple
column reference</a></span>s in the SELECT list</div></td></tr></table></div></div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example:   <pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">CREATE TABLE tab1 (c1 INT NOT NULL, 
    c2 INT NOT NULL, 
    c3 INT NOT NULL, 
    c4 CHAR(2), 
    PRIMARY KEY (c1, c2, c3))
CREATE TABLE tab2 (c1 INT NOT NULL,  
    c2 INT NOT NULL, 
    PRIMARY KEY (c1, c2))
INSERT INTO tab1 VALUES (1, 2, 3, 'WA'), 
    (1, 2, 5, 'WA'), 
    (1, 2, 4, 'CA'), 
    (1, 3, 5, 'CA'), 
    (2, 3, 1, 'CA')
INSERT INTO tab2 VALUES (1, 2), 
    (1, 3), 
    (2, 2), 
    (2, 3)
<span style="font-weight: bold;">-- all the columns in the index on the only table (tab1) appear
-- in the way required for the <span style="color: blue;"><a href="#rtuntransform29680">Primary table</a></span> (simple column references)</span>
SELECT DISTINCT c1, c2, c3, c4
FROM tab1
<span style="font-weight: bold;">-- all the columns in the index on the only table (tab1) appear
-- in the way required for the <span style="color: blue;"><a href="#rtuntransform29680">Primary table</a></span> (equality predicates) </span>
SELECT DISTINCT c3, c4
FROM tab1
WHERE c1 = 1
AND c2 = 2
AND c4 = 'WA'
<span style="font-weight: bold;">-- all the columns in the index on tab1 appear
-- in the way required for the <span style="color: blue;"><a href="#rtuntransform29680">Primary table</a></span>,
-- and all the columns in the
-- other tables appear in the way required
-- for a <span style="color: blue;"><a href="#rtuntransform16930">Secondary table</a></span></span>
SELECT DISTINCT tab1.c1, tab1.c3, tab1.c4
FROM tab1, tab2
WHERE tab1.c2 = 2
AND tab2.c2 = tab1.c2
AND tab2.c1 = tab1.c1</span></div></pre></div></div></div><div><a name="N16904"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform21780"></a><div></div>Combining ORDER BY and DISTINCT</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">Without a transformation, a statement that contains both DISTINCT and ORDER
BY would require two separate sorting steps-one to satisfy DISTINCT
and one to satisfy ORDER BY. (Currently, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> uses sorting to evaluate
DISTINCT. There are, in theory, other ways to accomplish this.) In some situations, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can
transform the statement internally into one that contains only one of these
keywords. The requirements are:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The columns in the ORDER BY list must be a subset of the columns in the
SELECT list.</div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>All the columns in the ORDER BY list are sorted in ascending order.</div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">A unique index is not required.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">For example:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT DISTINCT miles, meal
FROM Flights
ORDER BY meal</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">is transformed into  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT DISTINCT miles, meal
FROM Flights</span></div></pre>Note that these are not equivalent functions; this
is simply an internal <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> transformation.</div></div></div><div><a name="N169A6"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="ctuntransform14044"></a><div></div>Combining ORDER BY and UNION</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Without a transformation, a statement that contains both ORDER BY and UNION
would require two separate sorting steps-one to satisfy ORDER BY and
one to satisfy UNION (Currently <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> uses sorting to eliminate duplicates
from a UNION.  You can use UNION ALL to avoid sorting, but UNION ALL will return duplicates.  So you only use UNION ALL to avoid sorting if you know that there are no duplicate rows in the tables).</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;">In some situations, <span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> can transform the statement internally
into one that contains only one of these keywords (the ORDER BY is thrown
out). The requirements are:  
<div><table width="100%"><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>The columns in the ORDER BY list must be a subset of the columns in the
select list of the left side of the union. </div></td></tr><tr><td valign="top" style="text-align: right;" width="24"><div><span>&bull;</span></div></td><td width="8">&nbsp;</td><td valign="top"><div>All the columns in the ORDER BY list must be sorted in ascending order
and they must be an in-order prefix of the columns in the target list of the
left side of the UNION. </div></td></tr></table></div></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> will be able to transform the following statements:   
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT miles, meal
FROM Flights
UNION VALUES (1000, 'D')
ORDER BY 1
</span></div></pre></div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> cannot avoid two sorting nodes in the following statement,
because of the order of the columns in the ORDER BY clause:  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT flight_id, segment_number FROM Flights
UNION
SELECT flight_id, segment_number FROM FlightAvailability
ORDER BY segment_number , flight_id
</span></div></pre></div></div></div></div><div><a name="N16A4B"></a><div style="padding-top: 1pc; margin-bottom: 5pt; font-size: 14pt; font-weight: bold;"><div style="border-right-width: 0pt; border-left-width: 0pt; border-top-width: 1pt; border-top-color: black;"><a name="ctuntransform41535"></a><div></div>Aggregate processing</div></div><div style="margin-left: 72pt; font-size: 10pt;"></div><div><a name="N16ADD"></a><div style="padding-top: 1pc; margin-bottom: 2pt; font-size: 12pt; font-weight: bold;"><a name="rtuntransform867602"></a><div></div>COUNT(nonNullableColumn)</div><div style="margin-left: 72pt; font-size: 10pt;"><div style="line-height: 12pt; margin-top: 0.6em; font-size: 10pt;"><a name="N16AFC"></a><span></span><div style="font-size: 10pt; text-indent: 0em; margin-top: 0em; margin-bottom: 0.6em;"><span style="border-right-width: 0pt; border-left-width: 0pt;">Derby</span> transforms COUNT(nonNullableColumn) into COUNT(*). This improves
performance by potentially reducing the number of referenced columns in the
table (each referenced column needs to be read in for each row) and by giving
the optimizer more access path choices. For example, the cheapest access path
for  
<pre><div style="margin-top: 1.2em; margin-bottom: 0.8em; background-color: #f0f0f0; font-family: Courier; line-height: 106%; font-size: 9pt;"><span style="font-weight: bold;">SELECT COUNT(*) FROM t1</span></div></pre>is
the index on <span style="font-style: italic;">t1</span> with the smallest number of leaf pages,
and the optimizer is free to choose that path.</div></div></div></div></div></div><div><a name="N16B39"></a><div style="margin-top: 0pc; margin-bottom: 1.4pc; font-size: 16pt; font-weight: bold; padding-top: 1.4pc;"><div style="border-right-width: 0pt; border-left-width: 0pt; line-height: 100%; border-top-width: 3pt; border-top-color: black;"><a name="rtuntrademderby"></a><div></div>Trademarks</div></div><div style="margin-left: 72pt; font-size: 10pt;"><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">The following terms are trademarks or registered trademarks of other companies
and have been used in at least one of the documents in the <span style="border-right-width: 0pt; border-left-width: 0pt;">Apache Derby</span> documentation
library:</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Cloudscape, DB2, DB2 Universal Database, DRDA, and IBM are trademarks of
International Business Machines Corporation in the United States, other countries,
or both.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Microsoft, Windows, Windows NT, and the Windows logo are trademarks of
Microsoft Corporation in the United States, other countries, or both. </div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Oracle and Java are registered trademarks of Oracle and/or its affiliates.
Other names may be trademarks of their respective owners.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">UNIX is a registered trademark of The Open Group in the United States and
other countries.</div><div style="font-size: 10pt; text-indent: 0em; margin-top: 0.6em; margin-bottom: 0.6em;">Other company, product, or service names may be trademarks or service marks
of others.</div></div></div></div></div><div valign="top"><div style="font-family: Helvetica; font-weight: bold; font-size: 10pt; text-align: center;"><span>&bull;</span></div></div><br></body></html>